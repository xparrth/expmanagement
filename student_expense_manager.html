<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#006FCF">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Student Expense Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1a1a1a;
            --light: #e0e0e0;
            --success: #10b981;
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --accent: #3b82f6;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #2a2a2a;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #0a0a0a 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
            font-size: 16px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid #2a2a2a;
        }

        .header {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: white;
            padding: 30px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border-bottom: 1px solid #2a2a2a;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            opacity: 0.8;
            font-size: 1em;
            color: #b0b0b0;
        }

        .profile-section {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .profile-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .profile-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: #1a1a1a;
            margin: 5% auto 10% auto;
            padding: 0;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            animation: slideDown 0.3s;
            border: 1px solid #2a2a2a;
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2a2a2a;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            background: #1a1a1a;
            min-height: auto;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            font-size: 2.5em;
            font-weight: bold;
            position: relative;
            overflow: hidden;
            border: 3px solid #2a2a2a;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .avatar-upload-btn {
            display: none;
        }

        .profile-avatar-text {
            position: relative;
            z-index: 1;
        }

        .profile-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1em;
            overflow: hidden;
            border: 2px solid #2a2a2a;
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-avatar-small:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            border-color: #3a3a3a;
        }

        .profile-avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .change-photo-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            font-weight: 600;
        }

        .change-photo-btn:hover {
            background: #1e40af;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .remove-photo-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            font-weight: 600;
        }

        .remove-photo-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .profile-form .form-group {
            margin-bottom: 20px;
        }

        .profile-form label {
            display: block;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-weight: 600;
        }

        .profile-form input {
            width: 100%;
            padding: 12px;
            border: 2px solid #2a2a2a;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: #0a0a0a;
            color: #e0e0e0;
        }

        .profile-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            background: #121212;
        }

        .modal-footer {
            padding: 20px 30px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #2a2a2a;
            background: #1a1a1a;
            border-radius: 0 0 20px 20px;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .btn-cancel {
            background: #6b7280;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-cancel:hover {
            background: #4b5563;
        }

        .btn-save {
            background: var(--primary);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-save:hover {
            background: #1e40af;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4);
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            padding: 30px;
            transition: all 0.3s ease;
        }

        .card {
            background: #1e1e1e;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 1px solid #2a2a2a;
            min-width: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: all 0.4s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.7);
            border-color: #3a3a3a;
        }

        .card.dashboard-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #0f3460;
        }

        .card.dashboard-card::before {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            height: 3px;
        }

        .card.dashboard-card:hover {
            background: linear-gradient(135deg, #1e2139 0%, #1a2845 100%);
            border-color: #0f3460;
        }

        .card.add-transaction-card {
            background: linear-gradient(135deg, #2a1a0a 0%, #1e1408 100%);
            border: 1px solid #3d2912;
        }

        .card.add-transaction-card::before {
            background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
            height: 3px;
        }

        .card.add-transaction-card:hover {
            background: linear-gradient(135deg, #331f0d 0%, #261910 100%);
            border-color: #4d3416;
        }

        .card.transactions-card {
            background: linear-gradient(135deg, #0a1f1a 0%, #0d1f1a 100%);
            border: 1px solid #1a3d2e;
        }

        .card.transactions-card::before {
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            height: 3px;
        }

        .card.transactions-card:hover {
            background: linear-gradient(135deg, #0e2621 0%, #11261f 100%);
            border-color: #1e4d3a;
        }

        .card.analytics-card {
            background: linear-gradient(135deg, #1a0a2e 0%, #1a0e29 100%);
            border: 1px solid #2d1b47;
        }

        .card.analytics-card::before {
            background: linear-gradient(90deg, #a855f7 0%, #c084fc 100%);
            height: 3px;
        }

        .card.analytics-card:hover {
            background: linear-gradient(135deg, #220f38 0%, #1f1230 100%);
            border-color: #3a2654;
        }

        .card h2 {
            color: #e0e0e0;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #2a2a2a;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            -webkit-appearance: none;
            appearance: none;
            background: #0a0a0a;
            color: #e0e0e0;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            background: #121212;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #1e40af;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .btn-danger:hover,
        .btn-warning:hover,
        .btn-secondary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .custom-category-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 20px;
            color: #e0e0e0;
            font-size: 0.85em;
            font-weight: 600;
        }

        .custom-category-remove {
            background: #ef4444;
            border: none;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .custom-category-remove:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            transition: all 0.3s ease;
        }

        .dashboard-split {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
            align-items: start;
        }

        .stats-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .budget-section-wrapper {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.5);
            border: 1px solid #2a2a2a;
            position: relative;
            transition: all 0.4s ease;
        }

        .budget-section-wrapper:hover {
            background: #1e1e1e;
            border-color: #3a3a3a;
            box-shadow: 0 5px 15px rgba(0,0,0,0.7);
        }

        .budget-section-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px 15px 0 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px 12px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            min-width: 0;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.4);
        }

        .stat-card.income {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .stat-card.income:hover {
            box-shadow: 0 15px 30px rgba(107, 114, 128, 0.4);
        }

        .stat-card.expense {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        }

        .stat-card.expense:hover {
            box-shadow: 0 15px 30px rgba(156, 163, 175, 0.4);
        }

        .stat-card.balance {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        }

        .stat-card.balance:hover {
            box-shadow: 0 15px 30px rgba(75, 85, 99, 0.4);
        }

        .stat-card h3 {
            font-size: 0.75em;
            margin-bottom: 8px;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }

        .stat-card p {
            font-size: 1.3em;
            font-weight: 700;
            margin: 0;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 5px;
        }

        @media (max-width: 1200px) {
            .stat-card p {
                font-size: 1.2em;
            }
        }

        @media (max-width: 900px) {
            .stat-card p {
                font-size: 1.1em;
            }
        }

        .transactions {
            max-height: 500px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        .transactions::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .transaction-item {
            background: #121212;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid transparent;
            flex-wrap: wrap;
            gap: 10px;
            border: 1px solid #1a1a1a;
        }

        .transaction-item:hover {
            transform: translateX(8px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            background: #1a1a1a;
            border-color: #2a2a2a;
        }

        .transaction-item.income {
            border-left-color: var(--success);
        }

        .transaction-item.expense {
            border-left-color: var(--danger);
        }

        .transaction-info h4 {
            color: #e0e0e0;
            margin-bottom: 5px;
        }

        .transaction-info p {
            color: #808080;
            font-size: 0.9em;
        }

        .transaction-amount {
            font-size: 1.3em;
            font-weight: bold;
        }

        .transaction-amount.income {
            color: var(--success);
        }

        .transaction-amount.expense {
            color: var(--danger);
        }

        .transaction-actions {
            display: flex;
            gap: 10px;
        }

        .category-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 5px;
            font-weight: 600;
        }

        .category-food { background: #fef3c7; color: #f59e0b; font-weight: 600; }
        .category-transport { background: #dbeafe; color: #3b82f6; font-weight: 600; }
        .category-education { background: #d1fae5; color: #10b981; font-weight: 600; }
        .category-entertainment { background: #fce7f3; color: #ec4899; font-weight: 600; }
        .category-housing { background: #e0e7ff; color: #6366f1; font-weight: 600; }
        .category-other { background: #f3f4f6; color: #6b7280; font-weight: 600; }
        .category-scholarship { background: #d1fae5; color: #10b981; font-weight: 600; }
        .category-allowance { background: #dbeafe; color: #3b82f6; font-weight: 600; }
        .category-parttime { background: #fef3c7; color: #f59e0b; font-weight: 600; }
        
        /* Default style for custom categories */
        .category-tag {
            background: #e0e7ff;
            color: #4f46e5;
            font-weight: 600;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
            min-height: 200px;
            transition: height 0.3s ease;
        }

        canvas {
            max-height: 300px;
            width: 100% !important;
            height: auto !important;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            transition: all 0.3s ease;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #2a2a2a;
            background: #0a0a0a;
            color: #b0b0b0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .filter-btn.active,
        .filter-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4);
            transform: translateY(-2px);
        }

        .budget-section {
            margin-top: 20px;
        }

        .budget-bar {
            background: #1a1a1a;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
            border: 1px solid #2a2a2a;
        }

        .budget-progress {
            height: 100%;
            background: #3b82f6;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
            position: relative;
        }

        .budget-progress.warning {
            background: #f59e0b;
        }

        .budget-progress.over {
            background: #ef4444;
        }

        .budget-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #808080;
        }

        .budget-info .budget-label {
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .budget-info .budget-value {
            font-weight: 700;
            color: #e0e0e0;
            font-size: 1.1em;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #606060;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Extra small windows and very narrow viewports */
        @media (max-width: 600px) {
            .main-content {
                grid-template-columns: 1fr !important;
                padding: 15px;
            }

            .quick-amounts {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .transaction-actions {
                flex-wrap: wrap;
                gap: 5px;
            }
        }

        /* Small windows */
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }

        /* Medium windows */
        @media (min-width: 901px) and (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 25px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Tablet and below */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        /* Mobile devices */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.6em;
                margin-bottom: 5px;
            }

            .header p {
                font-size: 0.9em;
            }

            .profile-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                margin-bottom: 15px;
            }

            .profile-btn {
                padding: 8px 16px;
                font-size: 0.85em;
            }

            .modal-content {
                margin: 5% auto;
                width: 95%;
                max-height: 95vh;
            }

            .modal-body {
                padding: 20px;
            }

            .modal-footer {
                padding: 15px 20px;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            .card h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }

            .dashboard-split {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-card h3 {
                font-size: 0.85em;
            }

            .stat-card p {
                font-size: 1.8em;
            }

            .quick-amounts {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .quick-amount-btn {
                padding: 10px;
                font-size: 0.9em;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .btn {
                padding: 12px 20px;
                font-size: 0.95em;
            }

            .transaction-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .transaction-actions {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }

            .transaction-amount {
                font-size: 1.2em;
            }

            .filters {
                gap: 8px;
            }

            .filter-btn {
                padding: 8px 15px;
                font-size: 0.85em;
            }

            .export-section {
                flex-direction: column;
            }

            .export-section .btn {
                width: 100%;
            }

            .tab-buttons {
                gap: 8px;
            }

            .tab-btn {
                padding: 10px;
                font-size: 0.9em;
            }

            .chart-container {
                height: 250px;
            }

            .budget-section h3 {
                font-size: 1.05em;
                color: #e0e0e0;
                margin-bottom: 20px;
                font-weight: 600;
                letter-spacing: -0.2px;
            }

            .budget-status-message {
                margin-top: 12px;
                font-size: 0.9em;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .budget-status-icon {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.8em;
            }

            .budget-section-wrapper {
                padding: 20px;
            }
        }

        /* Small mobile devices */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.4em;
            }

            .header p {
                font-size: 0.85em;
            }

            .card {
                padding: 15px;
            }

            .card h2 {
                font-size: 1.2em;
            }

            .stat-card {
                padding: 18px;
            }

            .stat-card h3 {
                font-size: 0.8em;
            }

            .stat-card p {
                font-size: 1.6em;
            }

            .quick-amounts {
                grid-template-columns: 1fr;
            }

            .transaction-info h4 {
                font-size: 0.95em;
            }

            .transaction-info p {
                font-size: 0.85em;
            }

            .btn-danger,
            .btn-warning {
                padding: 6px 12px;
                font-size: 0.85em;
            }
        }

        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .main-content {
                grid-template-columns: repeat(2, 1fr);
            }

            .full-width {
                grid-column: 1 / -1;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn,
            .filter-btn,
            .quick-amount-btn,
            .tab-btn {
                min-height: 44px; /* Apple's recommended touch target size */
                min-width: 44px;
            }

            .transaction-item {
                padding: 18px;
            }

            .stat-card:hover {
                transform: none; /* Disable hover effects on touch devices */
            }

            .stat-card:active {
                transform: scale(0.98);
            }
        }

        /* iPad and tablets */
        @media (min-width: 769px) and (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .quick-amounts {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Large tablets and small desktops */
        @media (min-width: 1025px) and (max-width: 1366px) {
            .container {
                max-width: 1200px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .export-section {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            transition: all 0.3s ease;
        }

        .export-section .btn {
            flex: 1;
            min-width: 150px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            transition: all 0.3s ease;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #2a2a2a;
            background: #0a0a0a;
            color: #b0b0b0;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-btn:hover {
            background: #121212;
            border-color: #3a3a3a;
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 3px 10px rgba(37, 99, 235, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #2a2a2a;
            border-radius: 8px;
            font-size: 1em;
            background: #0a0a0a;
            color: #e0e0e0;
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: var(--primary);
            background: #121212;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .quick-amounts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
            gap: 8px;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }

        .quick-amount-btn {
            padding: 12px;
            border: 2px solid #2a2a2a;
            background: #0a0a0a;
            color: #b0b0b0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95em;
        }

        .quick-amount-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
            background: #121212;
        }

        .quick-amount-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 3px 10px rgba(37, 99, 235, 0.4);
        }

        .clear-amount-btn {
            background: #ef4444 !important;
            color: white !important;
            border-color: #ef4444 !important;
        }

        .clear-amount-btn:hover {
            background: #dc2626 !important;
            border-color: #dc2626 !important;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4) !important;
        }

        /* Currency Selection Overlay */
        #currencySelectionOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #0a0a0a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
            overflow-y: auto;
        }
        
        #currencySelectionOverlay.hidden {
            display: none;
        }

        .currency-selection-container {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            border: 1px solid #2a2a2a;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
        }

        .currency-selection-container h1 {
            color: #e0e0e0;
            margin-bottom: 15px;
            font-size: 2.2em;
        }

        .currency-selection-container .subtitle {
            color: #b0b0b0;
            margin-bottom: 25px;
            font-size: 1.05em;
        }

        .currency-warning {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid #ef4444;
            color: #ef4444;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .currency-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 30px;
        }

        .currency-option-card {
            background: #0a0a0a;
            border: 2px solid #2a2a2a;
            padding: 20px 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
        }

        .currency-option-card:hover {
            border-color: var(--primary);
            background: #121212;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .currency-option-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.5);
        }

        .currency-symbol-large {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .currency-code-large {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .currency-name-small {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .currency-option-card.selected .currency-name-small {
            opacity: 1;
        }

        .confirm-currency-selection {
            background: var(--primary);
            color: white;
            padding: 16px 40px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            max-width: 400px;
        }

        .confirm-currency-selection:hover:not(:disabled) {
            background: #1e40af;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.5);
        }

        .confirm-currency-selection:disabled {
            background: #4b5563;
            cursor: not-allowed;
            opacity: 0.6;
        }

        @media (max-width: 600px) {
            .currency-options-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .currency-selection-container {
                padding: 30px 20px;
            }

            .currency-selection-container h1 {
                font-size: 1.8em;
            }
        }

    </style>
</head>
<body>
    <!-- Currency Selection Overlay (One-Time) -->
    <div id="currencySelectionOverlay" class="hidden">
        <div class="currency-selection-container">
            <h1>üí∞ Welcome!</h1>
            <p class="subtitle">Select your preferred currency for tracking expenses</p>
            
            <div class="currency-warning">
                <span>‚ö†Ô∏è</span>
                <span>This is a ONE-TIME choice and cannot be changed later!</span>
            </div>
            
            <div class="currency-options-grid" id="currencyOptionsGrid">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <button class="confirm-currency-selection" id="confirmCurrencyBtn" disabled onclick="confirmCurrencySelection()">
                Confirm Selection
            </button>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <div class="profile-section">
                <div class="profile-avatar-small" id="avatarSmall">
                    <span id="avatarSmallText">S</span>
                </div>
                <button class="profile-btn" onclick="openProfileModal()">Edit Profile</button>
            </div>
            <h1>üí∞ Student Expense Manager</h1>
            <p>Track your finances, manage your budget, achieve your goals</p>
        </div>

        <div class="main-content">
            <!-- Dashboard Stats -->
            <div class="card dashboard-card full-width">
                <h2>Dashboard Overview</h2>
                
                <div class="dashboard-split">
                    <!-- Left Side: Stats -->
                    <div class="stats-section">
                        <div class="stats-grid">
                            <div class="stat-card income">
                                <h3>Income</h3>
                                <p id="totalIncome">$0.00</p>
                            </div>
                            <div class="stat-card expense">
                                <h3>Expenses</h3>
                                <p id="totalExpenses">$0.00</p>
                            </div>
                            <div class="stat-card balance">
                                <h3>Balance</h3>
                                <p id="balance">$0.00</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side: Budget Tracker -->
                    <div class="budget-section-wrapper">
                        <div class="budget-section">
                            <h3>Monthly Budget Tracker</h3>
                            <div class="form-group">
                                <input type="number" id="monthlyBudget" placeholder="Set your monthly budget" min="0">
                            </div>
                            <div class="budget-info">
                                <span class="budget-label">Spent</span>
                                <span class="budget-value" id="budgetPercentageText">$0.00</span>
                            </div>
                            <div class="budget-bar">
                                <div class="budget-progress" id="budgetProgress"></div>
                            </div>
                            <div class="budget-status-message" id="budgetStatus"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Transaction Form -->
            <div class="card add-transaction-card">
                <h2>Add Transaction</h2>
                <form id="transactionForm">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="type" required onchange="updateCategoryOptions()">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Amount (<span id="currencyLabel">$</span>)</label>
                        <div class="quick-amounts" id="quickAmountsContainer">
                            <button type="button" class="quick-amount-btn" data-amount="5"><span class="amount-symbol">$</span>5</button>
                            <button type="button" class="quick-amount-btn" data-amount="10"><span class="amount-symbol">$</span>10</button>
                            <button type="button" class="quick-amount-btn" data-amount="20"><span class="amount-symbol">$</span>20</button>
                            <button type="button" class="quick-amount-btn" data-amount="50"><span class="amount-symbol">$</span>50</button>
                            <button type="button" class="quick-amount-btn" data-amount="100"><span class="amount-symbol">$</span>100</button>
                            <button type="button" class="quick-amount-btn" data-amount="custom">Custom</button>
                            <button type="button" class="quick-amount-btn clear-amount-btn" onclick="clearAmount()">Clear</button>
                        </div>
                        <input type="number" id="amount" step="0.01" min="0.01" placeholder="0.00" required style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label>Category</label>
                        <select id="category" required>
                            <optgroup label="Expense Categories">
                                <option value="food">Food & Dining</option>
                                <option value="transport">Transportation</option>
                                <option value="education">Education</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="housing">Housing</option>
                                <option value="other">Other</option>
                            </optgroup>
                            <optgroup label="Income Categories">
                                <option value="scholarship">Scholarship</option>
                                <option value="allowance">Allowance</option>
                                <option value="parttime">Part-time Job</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Description <span id="descriptionRequired" style="display: none; color: var(--danger);">*</span></label>
                        <input type="text" id="description" placeholder="e.g., Lunch at cafeteria">
                    </div>

                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="date" required>
                    </div>

                    <button type="submit" class="btn btn-primary">Add Transaction</button>
                </form>
            </div>

            <!-- Transactions List -->
            <div class="card transactions-card">
                <h2>Recent Transactions</h2>
                
                <div class="search-box">
                    <input type="text" id="searchTransaction" placeholder="üîç Search transactions...">
                </div>

                <div class="filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="income">Income</button>
                    <button class="filter-btn" data-filter="expense">Expense</button>
                </div>

                <div class="transactions" id="transactionsList">
                    <div class="empty-state">
                        <p>No transactions yet. Add your first transaction!</p>
                    </div>
                </div>

                <div class="export-section">
                    <button class="btn btn-secondary" onclick="exportToCSV()">Get Details</button>
                    <button class="btn btn-warning" onclick="clearAllData()">Clear All</button>
                </div>
            </div>

            <!-- Analytics -->
            <div class="card analytics-card full-width">
                <h2>Analytics</h2>
                
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="showTab('categoryChart')">By Category</button>
                    <button class="tab-btn" onclick="showTab('monthlyChart')">Monthly Trend</button>
                </div>

                <div id="categoryChart" class="tab-content active">
                    <div class="chart-container">
                        <canvas id="expensePieChart"></canvas>
                    </div>
                </div>

                <div id="monthlyChart" class="tab-content">
                    <div class="chart-container">
                        <canvas id="monthlyBarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="close-btn" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="profile-avatar" id="avatarDisplay">
                    <span class="profile-avatar-text" id="avatarText">S</span>
                </div>
                <input type="file" id="avatarUpload" class="avatar-upload-btn" accept="image/*" onchange="handleAvatarUpload(event)">
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                    <button type="button" class="change-photo-btn" onclick="document.getElementById('avatarUpload').click()">Change Photo</button>
                    <button type="button" class="remove-photo-btn" id="removePhotoBtn" onclick="removeProfilePhoto()" style="display: none;">Remove Photo</button>
                </div>
                <form class="profile-form" id="profileForm">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="profileName" placeholder="Enter your name" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="profileEmail" placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <select id="profileCountry" onchange="updatePhoneCode()">
                            <option value="">Select Country</option>
                            <option value="US" data-code="+1">üá∫üá∏ United States (+1)</option>
                            <option value="GB" data-code="+44">üá¨üáß United Kingdom (+44)</option>
                            <option value="CA" data-code="+1">üá®üá¶ Canada (+1)</option>
                            <option value="AU" data-code="+61">üá¶üá∫ Australia (+61)</option>
                            <option value="IN" data-code="+91">üáÆüá≥ India (+91)</option>
                            <option value="DE" data-code="+49">üá©üá™ Germany (+49)</option>
                            <option value="FR" data-code="+33">üá´üá∑ France (+33)</option>
                            <option value="JP" data-code="+81">üáØüáµ Japan (+81)</option>
                            <option value="CN" data-code="+86">üá®üá≥ China (+86)</option>
                            <option value="SG" data-code="+65">üá∏üá¨ Singapore (+65)</option>
                            <option value="AE" data-code="+971">üá¶üá™ UAE (+971)</option>
                            <option value="SA" data-code="+966">üá∏üá¶ Saudi Arabia (+966)</option>
                            <option value="BR" data-code="+55">üáßüá∑ Brazil (+55)</option>
                            <option value="MX" data-code="+52">üá≤üáΩ Mexico (+52)</option>
                            <option value="ES" data-code="+34">üá™üá∏ Spain (+34)</option>
                            <option value="IT" data-code="+39">üáÆüáπ Italy (+39)</option>
                            <option value="RU" data-code="+7">üá∑üá∫ Russia (+7)</option>
                            <option value="KR" data-code="+82">üá∞üá∑ South Korea (+82)</option>
                            <option value="NL" data-code="+31">üá≥üá± Netherlands (+31)</option>
                            <option value="CH" data-code="+41">üá®üá≠ Switzerland (+41)</option>
                            <option value="SE" data-code="+46">üá∏üá™ Sweden (+46)</option>
                            <option value="NO" data-code="+47">üá≥üá¥ Norway (+47)</option>
                            <option value="DK" data-code="+45">üá©üá∞ Denmark (+45)</option>
                            <option value="PL" data-code="+48">üáµüá± Poland (+48)</option>
                            <option value="PK" data-code="+92">üáµüá∞ Pakistan (+92)</option>
                            <option value="BD" data-code="+880">üáßüá© Bangladesh (+880)</option>
                            <option value="PH" data-code="+63">üáµüá≠ Philippines (+63)</option>
                            <option value="TH" data-code="+66">üáπüá≠ Thailand (+66)</option>
                            <option value="VN" data-code="+84">üáªüá≥ Vietnam (+84)</option>
                            <option value="MY" data-code="+60">üá≤üáæ Malaysia (+60)</option>
                            <option value="ID" data-code="+62">üáÆüá© Indonesia (+62)</option>
                            <option value="ZA" data-code="+27">üáøüá¶ South Africa (+27)</option>
                            <option value="NG" data-code="+234">üá≥üá¨ Nigeria (+234)</option>
                            <option value="EG" data-code="+20">üá™üá¨ Egypt (+20)</option>
                            <option value="TR" data-code="+90">üáπüá∑ Turkey (+90)</option>
                            <option value="AR" data-code="+54">üá¶üá∑ Argentina (+54)</option>
                            <option value="CL" data-code="+56">üá®üá± Chile (+56)</option>
                            <option value="CO" data-code="+57">üá®üá¥ Colombia (+57)</option>
                            <option value="NZ" data-code="+64">üá≥üáø New Zealand (+64)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="phoneCode" readonly placeholder="+1" style="width: 80px; background: #1a1a1a; cursor: not-allowed;">
                            <input type="tel" id="profilePhone" placeholder="555-123-4567" style="flex: 1;">
                        </div>
                        <small style="color: #808080; font-size: 0.85em; display: block; margin-top: 5px;">
                            Select country to auto-fill phone code
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Institution Type</label>
                        <select id="institutionType" onchange="updateInstitutionList()">
                            <option value="">Select Type</option>
                            <option value="university">University/College</option>
                            <option value="school">School</option>
                        </select>
                    </div>
                    <div class="form-group" id="institutionSearchGroup" style="display: none;">
                        <label>Search Institution</label>
                        <input type="text" id="institutionSearch" placeholder="Type to search universities..." oninput="searchUniversities(this.value)">
                        <div id="universityResults" style="max-height: 200px; overflow-y: auto; border: 1px solid #2a2a2a; border-radius: 8px; margin-top: 5px; background: #0a0a0a; display: none;"></div>
                        <small style="color: #808080; font-size: 0.85em; display: block; margin-top: 5px;">
                            Search from 9,000+ universities worldwide
                        </small>
                    </div>
                    <div class="form-group" id="institutionSelectGroup" style="display: none;">
                        <label>Select School Type</label>
                        <select id="profileUniversitySelect" onchange="handleInstitutionSelect()">
                            <option value="">Select School Type</option>
                        </select>
                    </div>
                    <div class="form-group" id="institutionInputGroup">
                        <label>Institution Name</label>
                        <input type="text" id="profileUniversity" placeholder="Enter your institution name" readonly style="background: #1a1a1a;">
                        <small style="color: #808080; font-size: 0.85em; display: block; margin-top: 5px;">
                            Selected institution will appear here
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Student ID</label>
                        <input type="text" id="profileStudentId" placeholder="Your student ID">
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select id="profileCurrency" disabled style="background: #0a0a0a; cursor: not-allowed; opacity: 0.6;">
                            <option value="USD">USD ($) - US Dollar</option>
                            <option value="EUR">EUR (‚Ç¨) - Euro</option>
                            <option value="GBP">GBP (¬£) - British Pound</option>
                            <option value="JPY">JPY (¬•) - Japanese Yen</option>
                            <option value="INR">INR (‚Çπ) - Indian Rupee</option>
                            <option value="CAD">CAD ($) - Canadian Dollar</option>
                            <option value="AUD">AUD ($) - Australian Dollar</option>
                            <option value="CNY">CNY (¬•) - Chinese Yuan</option>
                            <option value="CHF">CHF (Fr) - Swiss Franc</option>
                            <option value="SGD">SGD ($) - Singapore Dollar</option>
                            <option value="AED">AED (ÿØ.ÿ•) - UAE Dirham</option>
                            <option value="SAR">SAR (Ô∑º) - Saudi Riyal</option>
                        </select>
                        <small style="color: #808080; font-size: 0.85em; display: block; margin-top: 5px;">
                            üîí Currency is locked and cannot be changed
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>Custom Categories</label>
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="text" id="newCategoryInput" placeholder="Enter category name" style="flex: 1;">
                                <select id="newCategoryType" style="width: 120px; padding: 10px; background: #0a0a0a; color: #e0e0e0; border: 2px solid #2a2a2a; border-radius: 8px;">
                                    <option value="expense">Expense</option>
                                    <option value="income">Income</option>
                                </select>
                                <button type="button" class="btn-secondary" onclick="addCustomCategory()" style="padding: 10px 20px; white-space: nowrap;">Add Category</button>
                            </div>
                        </div>
                        <div id="customCategoriesList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                            <!-- Custom categories will appear here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeProfileModal()">Cancel</button>
                <button class="btn-save" onclick="saveProfile()">Save Changes</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Currency configuration
        const availableCurrencies = [
            { code: 'USD', symbol: '$', name: 'US Dollar' },
            { code: 'EUR', symbol: '‚Ç¨', name: 'Euro' },
            { code: 'GBP', symbol: '¬£', name: 'British Pound' },
            { code: 'INR', symbol: '‚Çπ', name: 'Indian Rupee' },
            { code: 'JPY', symbol: '¬•', name: 'Japanese Yen' },
            { code: 'CAD', symbol: '$', name: 'Canadian Dollar' },
            { code: 'AUD', symbol: '$', name: 'Australian Dollar' },
            { code: 'CNY', symbol: '¬•', name: 'Chinese Yuan' },
            { code: 'CHF', symbol: 'Fr', name: 'Swiss Franc' },
            { code: 'SGD', symbol: '$', name: 'Singapore Dollar' },
            { code: 'AED', symbol: 'ÿØ.ÿ•', name: 'UAE Dirham' },
            { code: 'SAR', symbol: 'Ô∑º', name: 'Saudi Riyal' }
        ];

        let selectedCurrencyForSetup = null;

        function showCurrencySelection() {
            console.log('showCurrencySelection called');
            const overlay = document.getElementById('currencySelectionOverlay');
            const grid = document.getElementById('currencyOptionsGrid');
            
            console.log('Overlay element:', overlay);
            console.log('Grid element:', grid);
            
            // Generate currency cards
            grid.innerHTML = availableCurrencies.map(curr => `
                <div class="currency-option-card" data-currency="${curr.code}">
                    <div class="currency-symbol-large">${curr.symbol}</div>
                    <div class="currency-code-large">${curr.code}</div>
                    <div class="currency-name-small">${curr.name}</div>
                </div>
            `).join('');
            
            console.log('Currency cards generated:', document.querySelectorAll('.currency-option-card').length);
            
            // Add click listeners
            document.querySelectorAll('.currency-option-card').forEach(card => {
                card.addEventListener('click', function() {
                    console.log('Card clicked:', this.getAttribute('data-currency'));
                    selectCurrencyOption(this.getAttribute('data-currency'));
                });
            });
            
            // Show overlay
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex';
            
            console.log('Overlay should be visible now');
        }

        function selectCurrencyOption(code) {
            selectedCurrencyForSetup = code;
            
            // Remove selected class from all
            document.querySelectorAll('.currency-option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            document.querySelector(`[data-currency="${code}"]`).classList.add('selected');
            
            // Enable confirm button
            document.getElementById('confirmCurrencyBtn').disabled = false;
        }

        window.confirmCurrencySelection = function() {
            console.log('Confirm button clicked!');
            console.log('Selected currency:', selectedCurrencyForSetup);
            
            if (!selectedCurrencyForSetup) {
                alert('Please select a currency first!');
                return;
            }
            
            // Double confirmation
            const currencyInfo = availableCurrencies.find(c => c.code === selectedCurrencyForSetup);
            console.log('Currency info:', currencyInfo);
            
            const confirmed = confirm(
                `You are about to set ${currencyInfo.name} (${currencyInfo.symbol}) as your currency.\n\n` +
                `‚ö†Ô∏è WARNING: This choice is PERMANENT and cannot be changed!\n\n` +
                `Are you absolutely sure?`
            );
            
            if (!confirmed) {
                console.log('User cancelled confirmation');
                return;
            }
            
            console.log('User confirmed, locking currency...');
            
            // Ensure userProfile exists
            if (!userProfile) {
                userProfile = {
                    name: 'Student',
                    email: '',
                    phone: '',
                    phoneCode: '',
                    country: '',
                    university: '',
                    studentId: '',
                    avatar: null,
                    currency: 'USD',
                    customCategories: {
                        expense: [],
                        income: []
                    }
                };
            }
            
            // Lock the currency
            userProfile.currency = selectedCurrencyForSetup;
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            localStorage.setItem('currencyLocked', 'true');
            
            console.log('Currency locked successfully');
            
            // Hide overlay
            const overlay = document.getElementById('currencySelectionOverlay');
            overlay.classList.add('hidden');
            overlay.style.display = 'none';
            
            console.log('Initializing app...');
            
            // Initialize the app
            try {
                updateDashboard();
                displayTransactions();
                updateCharts();
                updateAvatarDisplay();
                updateCurrencyLabel();
                updateCategoryDropdown();
                
                alert(`‚úÖ Currency set to ${currencyInfo.name}! This cannot be changed.`);
            } catch (error) {
                console.error('Error initializing app:', error);
                alert('App initialized with ' + currencyInfo.name);
            }
        };

        // Data storage
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let monthlyBudget = parseFloat(localStorage.getItem('monthlyBudget')) || 0;
        let currentFilter = 'all';
        let currentTransactionCurrency = 'USD'; // Track currency for current transaction
        let universitySearchTimeout = null;
        let cachedUniversities = null;

        // Major Universities by Country/Region
        const universities = {
            'US': [
                'Harvard University', 'Stanford University', 'MIT', 'Yale University', 'Princeton University',
                'Columbia University', 'University of Chicago', 'University of Pennsylvania', 'Cornell University',
                'Duke University', 'Northwestern University', 'Johns Hopkins University', 'Brown University',
                'University of California, Berkeley', 'UCLA', 'University of Michigan', 'New York University',
                'University of Southern California', 'Boston University', 'Carnegie Mellon University'
            ],
            'UK': [
                'University of Oxford', 'University of Cambridge', 'Imperial College London', 
                'University College London (UCL)', 'London School of Economics (LSE)', 
                'University of Edinburgh', 'King\'s College London', 'University of Manchester',
                'University of Bristol', 'University of Warwick', 'University of Glasgow'
            ],
            'CA': [
                'University of Toronto', 'McGill University', 'University of British Columbia',
                'McMaster University', 'University of Alberta', 'University of Waterloo',
                'Western University', 'Queen\'s University', 'University of Montreal'
            ],
            'AU': [
                'University of Melbourne', 'Australian National University', 'University of Sydney',
                'University of Queensland', 'Monash University', 'UNSW Sydney',
                'University of Western Australia', 'University of Adelaide'
            ],
            'IN': [
                'IIT Bombay', 'IIT Delhi', 'IIT Madras', 'IIT Kanpur', 'IIT Kharagpur', 'IIT Roorkee',
                'IISc Bangalore', 'BITS Pilani', 'Delhi University', 'Jawaharlal Nehru University',
                'University of Mumbai', 'University of Calcutta', 'Anna University', 'Banaras Hindu University',
                'Manipal Academy', 'Vellore Institute of Technology (VIT)', 'SRM Institute', 'Amity University'
            ],
            'CN': [
                'Tsinghua University', 'Peking University', 'Fudan University', 'Shanghai Jiao Tong University',
                'Zhejiang University', 'University of Science and Technology of China', 'Nanjing University'
            ],
            'JP': [
                'University of Tokyo', 'Kyoto University', 'Osaka University', 'Tohoku University',
                'Nagoya University', 'Keio University', 'Waseda University'
            ],
            'SG': [
                'National University of Singapore (NUS)', 'Nanyang Technological University (NTU)',
                'Singapore Management University (SMU)'
            ],
            'DE': [
                'Technical University of Munich', 'LMU Munich', 'Heidelberg University',
                'Humboldt University of Berlin', 'RWTH Aachen University', 'University of Freiburg'
            ],
            'FR': [
                'Sorbonne University', '√âcole Polytechnique', 'Sciences Po', 'ENS Paris',
                'University of Paris', '√âcole Normale Sup√©rieure'
            ],
            'NL': [
                'University of Amsterdam', 'Delft University of Technology', 'Utrecht University',
                'Leiden University', 'Erasmus University Rotterdam'
            ],
            'CH': [
                'ETH Zurich', 'EPFL', 'University of Zurich', 'University of Geneva'
            ],
            'GLOBAL': [
                'Online University', 'Distance Learning Program', 'International Program'
            ]
        };

        // Schools by level
        const schools = {
            'high': [
                'High School', 'Secondary School', 'Grammar School', 'Preparatory School',
                'International High School', 'Private High School', 'Public High School'
            ],
            'middle': [
                'Middle School', 'Junior High School', 'Intermediate School'
            ],
            'primary': [
                'Primary School', 'Elementary School', 'Grade School'
            ],
            'boarding': [
                'Boarding School', 'Residential School', 'International Boarding School'
            ]
        };
        let userProfile = JSON.parse(localStorage.getItem('userProfile')) || {
            name: 'Student',
            email: '',
            phone: '',
            phoneCode: '',
            country: '',
            university: '',
            studentId: '',
            avatar: null,
            currency: 'USD',
            customCategories: {
                expense: [],
                income: []
            }
        };

        // Currency symbols mapping
        const currencySymbols = {
            'USD': '$',
            'EUR': '‚Ç¨',
            'GBP': '¬£',
            'JPY': '¬•',
            'INR': '‚Çπ',
            'CAD': '$',
            'AUD': '$',
            'CNY': '¬•',
            'CHF': 'Fr',
            'SGD': '$',
            'AED': 'ÿØ.ÿ•',
            'SAR': 'Ô∑º'
        };

        // Quick amount values for different currencies
        const currencyQuickAmounts = {
            'USD': [5, 10, 20, 50, 100],
            'EUR': [5, 10, 20, 50, 100],
            'GBP': [5, 10, 20, 50, 100],
            'JPY': [500, 1000, 2000, 5000, 10000],
            'INR': [100, 200, 500, 1000, 2000],
            'CAD': [5, 10, 20, 50, 100],
            'AUD': [5, 10, 20, 50, 100],
            'CNY': [20, 50, 100, 200, 500],
            'CHF': [5, 10, 20, 50, 100],
            'SGD': [5, 10, 20, 50, 100],
            'AED': [20, 50, 100, 200, 500],
            'SAR': [20, 50, 100, 200, 500]
        };

        function getCurrencySymbol() {
            return currencySymbols[userProfile.currency] || '$';
        }

        function formatCurrency(amount) {
            const symbol = getCurrencySymbol();
            return `${symbol}${amount.toFixed(2)}`;
        }

        function getQuickAmounts() {
            return currencyQuickAmounts[userProfile.currency] || [5, 10, 20, 50, 100];
        }

        // Set today's date as default
        document.getElementById('date').valueAsDate = new Date();

        // Quick amount buttons functionality
        const amountInput = document.getElementById('amount');
        const quickAmountBtns = document.querySelectorAll('.quick-amount-btn');

        let lastClickedBtn = null;

        quickAmountBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const amount = this.dataset.amount;
                
                if(amount === 'custom') {
                    // Remove active class from all buttons
                    quickAmountBtns.forEach(b => b.classList.remove('active'));
                    // Add active class to custom button
                    this.classList.add('active');
                    amountInput.value = '';
                    amountInput.focus();
                    lastClickedBtn = null;
                } else if (!amount) {
                    // Skip for clear button (handled separately)
                    return;
                } else {
                    // Always add to existing amount (additive behavior)
                    const currentAmount = parseFloat(amountInput.value) || 0;
                    const addAmount = parseFloat(amount);
                    amountInput.value = (currentAmount + addAmount).toFixed(2);
                    
                    // Update active state
                    quickAmountBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    lastClickedBtn = this;
                }
            });
        });

        // Clear amount function
        function clearAmount() {
            amountInput.value = '';
            quickAmountBtns.forEach(b => b.classList.remove('active'));
            document.querySelector('.quick-amount-btn[data-amount="custom"]').classList.add('active');
            lastClickedBtn = null;
        }

        // When user types in custom amount, activate custom button
        amountInput.addEventListener('input', function() {
            const customBtn = document.querySelector('.quick-amount-btn[data-amount="custom"]');
            const isQuickAmount = Array.from(quickAmountBtns).some(btn => {
                return btn.dataset.amount !== 'custom' && btn.dataset.amount === this.value;
            });

            if(!isQuickAmount && this.value !== '') {
                quickAmountBtns.forEach(b => b.classList.remove('active'));
                customBtn.classList.add('active');
                lastClickedBtn = null; // Reset tracking when manually typing
            }
        });

        // Category change handler - make description required only for "other"
        const categorySelect = document.getElementById('category');
        const descriptionInput = document.getElementById('description');
        const descriptionRequired = document.getElementById('descriptionRequired');

        categorySelect.addEventListener('change', function() {
            if(this.value === 'other') {
                descriptionInput.setAttribute('required', 'required');
                descriptionRequired.style.display = 'inline';
                descriptionInput.placeholder = "Please specify what this is for";
            } else {
                descriptionInput.removeAttribute('required');
                descriptionRequired.style.display = 'none';
                descriptionInput.placeholder = "e.g., Lunch at cafeteria (optional)";
            }
        });

        // Set budget value
        document.getElementById('monthlyBudget').value = monthlyBudget || '';

        // Budget input listener
        document.getElementById('monthlyBudget').addEventListener('change', function() {
            monthlyBudget = parseFloat(this.value) || 0;
            localStorage.setItem('monthlyBudget', monthlyBudget);
            updateDashboard();
        });

        // Form submission
        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedCurrency = userProfile.currency;
            const currencySymbol = getCurrencySymbol();
            
            if(editingTransactionId) {
                // Update existing transaction
                const index = transactions.findIndex(t => t.id === editingTransactionId);
                if(index !== -1) {
                    transactions[index] = {
                        id: editingTransactionId,
                        type: document.getElementById('type').value,
                        amount: parseFloat(document.getElementById('amount').value),
                        category: document.getElementById('category').value,
                        description: document.getElementById('description').value,
                        date: document.getElementById('date').value,
                        currency: selectedCurrency,
                        currencySymbol: currencySymbol
                    };
                    
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    
                    // Show success message
                    alert('Transaction updated successfully!');
                    
                    // Cancel edit mode
                    cancelEdit();
                }
            } else {
                // Add new transaction with currency
                const transaction = {
                    id: Date.now(),
                    type: document.getElementById('type').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    category: document.getElementById('category').value,
                    description: document.getElementById('description').value,
                    date: document.getElementById('date').value,
                    currency: selectedCurrency,
                    currencySymbol: currencySymbol
                };

                transactions.unshift(transaction);
                localStorage.setItem('transactions', JSON.stringify(transactions));

                // Reset form
                this.reset();
                document.getElementById('date').valueAsDate = new Date();

                // Reset quick amount buttons - deselect all
                quickAmountBtns.forEach(b => b.classList.remove('active'));
                document.querySelector('.quick-amount-btn[data-amount="custom"]').classList.add('active');
                lastClickedBtn = null;

                // Show success message
                alert('Transaction added successfully!');
            }

            // Update UI
            updateDashboard();
            displayTransactions();
            updateCharts();
        });

        // Display transactions
        function displayTransactions(filter = currentFilter, searchTerm = '') {
            const container = document.getElementById('transactionsList');
            
            let filtered = transactions;

            // Apply filter
            if (filter !== 'all') {
                filtered = filtered.filter(t => t.type === filter);
            }

            // Apply search
            if (searchTerm) {
                filtered = filtered.filter(t => 
                    t.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    t.category.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No transactions found.</p></div>';
                return;
            }

            container.innerHTML = filtered.map(t => {
                // Use transaction's original currency if available, otherwise use current
                const txnSymbol = t.currencySymbol || getCurrencySymbol();
                const txnCurrency = t.currency || userProfile.currency;
                
                return `
                <div class="transaction-item ${t.type}">
                    <div class="transaction-info">
                        <h4>${t.description}</h4>
                        <p>${new Date(t.date).toLocaleDateString()} 
                           <span class="category-tag category-${t.category}">${t.category}</span>
                           <span style="color: #606060; font-size: 0.85em;"> ‚Ä¢ ${txnCurrency}</span>
                        </p>
                    </div>
                    <div class="transaction-actions">
                        <span class="transaction-amount ${t.type}">
                            ${t.type === 'income' ? '+' : '-'}${txnSymbol}${t.amount.toFixed(2)}
                        </span>
                        <button class="btn btn-warning" onclick="editTransaction(${t.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteTransaction(${t.id})">üóëÔ∏è</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Delete transaction
        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                updateDashboard();
                displayTransactions();
                updateCharts();
            }
        }

        // Track if we're editing
        let editingTransactionId = null;

        // Edit transaction
        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            // Populate form with transaction data
            document.getElementById('type').value = transaction.type;
            document.getElementById('amount').value = transaction.amount;
            document.getElementById('category').value = transaction.category;
            document.getElementById('description').value = transaction.description;
            document.getElementById('date').value = transaction.date;

            // Update quick amount buttons to show custom
            quickAmountBtns.forEach(b => b.classList.remove('active'));
            document.querySelector('.quick-amount-btn[data-amount="custom"]').classList.add('active');

            // Set editing mode
            editingTransactionId = id;

            // Update submit button
            const submitBtn = document.querySelector('#transactionForm button[type="submit"]');
            submitBtn.textContent = 'Update Transaction';
            submitBtn.style.background = 'var(--warning)';

            // Scroll to form
            document.querySelector('#transactionForm').scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Show cancel button if not exists
            if(!document.getElementById('cancelEditBtn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.id = 'cancelEditBtn';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.textContent = 'Cancel Edit';
                cancelBtn.style.marginTop = '10px';
                cancelBtn.onclick = cancelEdit;
                submitBtn.parentNode.appendChild(cancelBtn);
            }
        }

        // Cancel edit mode
        function cancelEdit() {
            editingTransactionId = null;
            
            // Reset form
            document.getElementById('transactionForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            
            // Reset submit button
            const submitBtn = document.querySelector('#transactionForm button[type="submit"]');
            submitBtn.textContent = 'Add Transaction';
            submitBtn.style.background = 'var(--primary)';
            
            // Remove cancel button
            const cancelBtn = document.getElementById('cancelEditBtn');
            if(cancelBtn) {
                cancelBtn.remove();
            }
            
            // Reset quick amount buttons
            quickAmountBtns.forEach(b => b.classList.remove('active'));
            document.querySelector('.quick-amount-btn[data-amount="custom"]').classList.add('active');
        }

        // Update dashboard
        function updateDashboard() {
            // Group transactions by currency
            const currentCurrency = userProfile.currency;
            
            // Calculate totals for current currency only
            const income = transactions
                .filter(t => t.type === 'income' && (t.currency === currentCurrency || !t.currency))
                .reduce((sum, t) => sum + t.amount, 0);

            const expenses = transactions
                .filter(t => t.type === 'expense' && (t.currency === currentCurrency || !t.currency))
                .reduce((sum, t) => sum + t.amount, 0);

            const balance = income - expenses;

            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpenses').textContent = formatCurrency(expenses);
            document.getElementById('balance').textContent = formatCurrency(balance);

            // Update budget progress
            if (monthlyBudget > 0) {
                const percentage = (expenses / monthlyBudget) * 100;
                const progressBar = document.getElementById('budgetProgress');
                const percentageText = document.getElementById('budgetPercentageText');
                const statusElement = document.getElementById('budgetStatus');
                
                progressBar.style.width = Math.min(percentage, 100) + '%';
                percentageText.textContent = `${percentage.toFixed(1)}%`;
                
                // Remove all classes
                progressBar.classList.remove('warning', 'over');
                
                if (percentage > 100) {
                    progressBar.classList.add('over');
                    statusElement.innerHTML = 
                        `<span style="color: #ef4444;">Over budget by ${formatCurrency(expenses - monthlyBudget)}</span>`;
                } else if (percentage > 80) {
                    progressBar.classList.add('warning');
                    statusElement.innerHTML = 
                        `<span style="color: #f59e0b;">Remaining: ${formatCurrency(monthlyBudget - expenses)}</span>`;
                } else {
                    statusElement.innerHTML = 
                        `<span style="color: #10b981;">Remaining: ${formatCurrency(monthlyBudget - expenses)}</span>`;
                }
            } else {
                document.getElementById('budgetPercentageText').textContent = formatCurrency(0);
                document.getElementById('budgetStatus').innerHTML = '';
            }
        }

        // Filter transactions
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                displayTransactions(currentFilter);
            });
        });

        // Search functionality
        document.getElementById('searchTransaction').addEventListener('input', function() {
            displayTransactions(currentFilter, this.value);
        });

        // Export to CSV
        function exportToCSV() {
            if (transactions.length === 0) {
                alert('No transactions to export!');
                return;
            }

            const csv = [
                ['Date', 'Type', 'Category', 'Description', 'Amount'],
                ...transactions.map(t => [
                    t.date,
                    t.type,
                    t.category,
                    t.description,
                    t.amount
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL transactions? This cannot be undone!')) {
                transactions = [];
                localStorage.setItem('transactions', JSON.stringify(transactions));
                updateDashboard();
                displayTransactions();
                updateCharts();
            }
        }

        // Charts
        let expenseChart = null;
        let monthlyChart = null;

        function updateCharts() {
            updateExpensePieChart();
            updateMonthlyBarChart();
        }

        function updateExpensePieChart() {
            const ctx = document.getElementById('expensePieChart').getContext('2d');
            
            const expensesByCategory = transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            const labels = Object.keys(expensesByCategory);
            const data = Object.values(expensesByCategory);

            if (expenseChart) {
                expenseChart.destroy();
            }

            if (labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = '#808080';
                ctx.font = '16px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No expense data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#f59e0b', // Food
                            '#3b82f6', // Transport
                            '#10b981', // Education
                            '#ec4899', // Entertainment
                            '#6366f1', // Housing
                            '#6b7280', // Other
                            '#8b5cf6', // Custom 1
                            '#14b8a6', // Custom 2
                            '#f97316', // Custom 3
                            '#06b6d4'  // Custom 4
                        ],
                        borderColor: '#1a1a1a',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e0e0e0',
                                padding: 15,
                                font: {
                                    size: 12,
                                    family: 'Inter, sans-serif'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Expenses by Category',
                            color: '#e0e0e0',
                            font: {
                                size: 16,
                                weight: 'bold',
                                family: 'Inter, sans-serif'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#2a2a2a',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${getCurrencySymbol()}${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateMonthlyBarChart() {
            const ctx = document.getElementById('monthlyBarChart').getContext('2d');
            
            // Get last 6 months
            const months = [];
            const incomeData = [];
            const expenseData = [];

            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                months.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));

                const monthIncome = transactions
                    .filter(t => t.type === 'income' && t.date.startsWith(monthKey))
                    .reduce((sum, t) => sum + t.amount, 0);

                const monthExpense = transactions
                    .filter(t => t.type === 'expense' && t.date.startsWith(monthKey))
                    .reduce((sum, t) => sum + t.amount, 0);

                incomeData.push(monthIncome);
                expenseData.push(monthExpense);
            }

            if (monthlyChart) {
                monthlyChart.destroy();
            }

            const hasData = incomeData.some(v => v > 0) || expenseData.some(v => v > 0);
            
            if (!hasData) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = '#808080';
                ctx.font = '16px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No transaction data for the last 6 months', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Income',
                            data: incomeData,
                            backgroundColor: '#10b981',
                            borderColor: '#059669',
                            borderWidth: 1,
                            borderRadius: 5
                        },
                        {
                            label: 'Expenses',
                            data: expenseData,
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 1,
                            borderRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e0e0e0',
                                padding: 15,
                                font: {
                                    size: 12,
                                    family: 'Inter, sans-serif'
                                },
                                usePointStyle: true,
                                pointStyle: 'rect'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Monthly Income vs Expenses',
                            color: '#e0e0e0',
                            font: {
                                size: 16,
                                weight: 'bold',
                                family: 'Inter, sans-serif'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#2a2a2a',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y || 0;
                                    return `${label}: ${getCurrencySymbol()}${value.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#e0e0e0',
                                font: {
                                    size: 11,
                                    family: 'Inter, sans-serif'
                                },
                                callback: function(value) {
                                    return getCurrencySymbol() + value.toFixed(0);
                                }
                            },
                            grid: {
                                color: '#2a2a2a',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0',
                                font: {
                                    size: 11,
                                    family: 'Inter, sans-serif'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // Tab switching
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Profile Modal Functions
        function openProfileModal() {
            document.getElementById('profileModal').style.display = 'block';
            document.getElementById('profileName').value = userProfile.name;
            document.getElementById('profileEmail').value = userProfile.email;
            document.getElementById('profilePhone').value = userProfile.phone;
            document.getElementById('profileCountry').value = userProfile.country || '';
            document.getElementById('phoneCode').value = userProfile.phoneCode || '';
            document.getElementById('profileUniversity').value = userProfile.university;
            document.getElementById('institutionType').value = userProfile.institutionType || '';
            document.getElementById('profileStudentId').value = userProfile.studentId;
            document.getElementById('profileCurrency').value = userProfile.currency;
            
            // Update avatar display
            updateAvatarDisplay();
            displayCustomCategories();
            
            // Update institution list if type is set
            if (userProfile.institutionType) {
                updateInstitutionList();
            }
        }

        // Update institution list based on type and country
        function updateInstitutionList() {
            const type = document.getElementById('institutionType').value;
            const searchGroup = document.getElementById('institutionSearchGroup');
            const selectGroup = document.getElementById('institutionSelectGroup');
            const inputGroup = document.getElementById('institutionInputGroup');
            const input = document.getElementById('profileUniversity');
            
            // Reset displays
            searchGroup.style.display = 'none';
            selectGroup.style.display = 'none';
            document.getElementById('universityResults').style.display = 'none';
            
            if (!type) {
                input.value = '';
                input.removeAttribute('readonly');
                input.placeholder = 'Enter your institution name';
                return;
            }
            
            if (type === 'university') {
                // Show search box for universities
                searchGroup.style.display = 'block';
                input.setAttribute('readonly', 'readonly');
                input.style.background = '#1a1a1a';
                input.placeholder = 'Search for your university above';
                
            } else if (type === 'school') {
                // Show dropdown for schools
                selectGroup.style.display = 'block';
                const select = document.getElementById('profileUniversitySelect');
                
                let options = '<option value="">Select School Type</option>';
                options += '<optgroup label="High Schools">';
                schools['high'].forEach(school => {
                    options += `<option value="${school}">${school}</option>`;
                });
                options += '</optgroup>';
                
                options += '<optgroup label="Middle Schools">';
                schools['middle'].forEach(school => {
                    options += `<option value="${school}">${school}</option>`;
                });
                options += '</optgroup>';
                
                options += '<optgroup label="Primary Schools">';
                schools['primary'].forEach(school => {
                    options += `<option value="${school}">${school}</option>`;
                });
                options += '</optgroup>';
                
                options += '<optgroup label="Boarding Schools">';
                schools['boarding'].forEach(school => {
                    options += `<option value="${school}">${school}</option>`;
                });
                options += '</optgroup>';
                
                select.innerHTML = options;
                input.setAttribute('readonly', 'readonly');
                input.style.background = '#1a1a1a';
            }
        }

        // Search universities using API
        async function searchUniversities(query) {
            const resultsDiv = document.getElementById('universityResults');
            
            if (!query || query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            // Clear previous timeout
            if (universitySearchTimeout) {
                clearTimeout(universitySearchTimeout);
            }
            
            // Debounce search
            universitySearchTimeout = setTimeout(async () => {
                try {
                    resultsDiv.innerHTML = '<div style="padding: 10px; color: #808080;">Searching...</div>';
                    resultsDiv.style.display = 'block';
                    
                    // Fetch universities from API
                    const response = await fetch(`http://universities.hipolabs.com/search?name=${encodeURIComponent(query)}`);
                    
                    if (!response.ok) {
                        throw new Error('API request failed');
                    }
                    
                    const data = await response.json();
                    
                    if (data.length === 0) {
                        resultsDiv.innerHTML = '<div style="padding: 10px; color: #808080;">No universities found. Try a different search term.</div>';
                        return;
                    }
                    
                    // Limit to first 50 results
                    const universities = data.slice(0, 50);
                    
                    resultsDiv.innerHTML = universities.map(uni => `
                        <div onclick="selectUniversity('${uni.name.replace(/'/g, "\\'")}', '${uni.country}')" 
                             style="padding: 12px; cursor: pointer; border-bottom: 1px solid #1a1a1a; transition: background 0.2s;"
                             onmouseover="this.style.background='#1a1a1a'"
                             onmouseout="this.style.background='transparent'">
                            <div style="color: #e0e0e0; font-weight: 600;">${uni.name}</div>
                            <div style="color: #808080; font-size: 0.85em;">${uni.country}</div>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error('Error fetching universities:', error);
                    resultsDiv.innerHTML = `
                        <div style="padding: 10px; color: #ef4444;">
                            Unable to search online. Please check your internet connection or enter manually.
                        </div>
                    `;
                }
            }, 300); // Wait 300ms after user stops typing
        }

        // Select university from results
        function selectUniversity(name, country) {
            document.getElementById('profileUniversity').value = name;
            document.getElementById('institutionSearch').value = name;
            document.getElementById('universityResults').style.display = 'none';
        }

        // Handle institution selection (for schools)
        function handleInstitutionSelect() {
            const select = document.getElementById('profileUniversitySelect');
            const input = document.getElementById('profileUniversity');
            const value = select.value;
            
            if (value) {
                input.value = value;
            }
        }

        // Update phone code based on country selection
        function updatePhoneCode() {
            const countrySelect = document.getElementById('profileCountry');
            const selectedOption = countrySelect.options[countrySelect.selectedIndex];
            const phoneCode = selectedOption.getAttribute('data-code') || '';
            
            document.getElementById('phoneCode').value = phoneCode;
        }

        // Add custom category
        function addCustomCategory() {
            try {
                const input = document.getElementById('newCategoryInput');
                const typeSelect = document.getElementById('newCategoryType');
                
                if (!input || !typeSelect) {
                    console.error('Input elements not found');
                    return;
                }
                
                const categoryName = input.value.trim();
                const categoryType = typeSelect.value;
                
                if (!categoryName) {
                    alert('Please enter a category name');
                    return;
                }
                
                // Initialize customCategories if it doesn't exist or is old format
                if (!userProfile.customCategories || Array.isArray(userProfile.customCategories)) {
                    userProfile.customCategories = {
                        expense: [],
                        income: []
                    };
                }
                
                const lowerCaseName = categoryName.toLowerCase();
                
                // Check if category already exists in either type
                const allCategories = [...userProfile.customCategories.expense, ...userProfile.customCategories.income];
                if (allCategories.includes(lowerCaseName)) {
                    alert('This category already exists');
                    return;
                }
                
                // Add to profile based on type
                userProfile.customCategories[categoryType].push(lowerCaseName);
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                
                // Clear input and refresh display
                input.value = '';
                displayCustomCategories();
                updateCategoryOptions();
                
                console.log('Category added successfully:', categoryName, 'as', categoryType);
            } catch (error) {
                console.error('Error adding category:', error);
                alert('Error adding category. Please try again.');
            }
        }

        // Display custom categories
        function displayCustomCategories() {
            try {
                const container = document.getElementById('customCategoriesList');
                if (!container) {
                    console.error('Categories list container not found');
                    return;
                }
                
                // Initialize customCategories if it doesn't exist or is old format
                if (!userProfile.customCategories || Array.isArray(userProfile.customCategories)) {
                    userProfile.customCategories = {
                        expense: [],
                        income: []
                    };
                }
                
                const expenseCategories = userProfile.customCategories.expense || [];
                const incomeCategories = userProfile.customCategories.income || [];
                
                if (expenseCategories.length === 0 && incomeCategories.length === 0) {
                    container.innerHTML = '<span style="color: #808080; font-size: 0.9em;">No custom categories added yet</span>';
                    return;
                }
                
                let html = '';
                
                // Display expense categories
                if (expenseCategories.length > 0) {
                    html += '<div style="width: 100%; margin-bottom: 10px;"><span style="color: #b0b0b0; font-size: 0.85em; font-weight: 600;">EXPENSE CATEGORIES:</span></div>';
                    html += expenseCategories.map(cat => `
                        <div class="custom-category-tag" style="background: #2a1a0a; border-color: #3d2912;">
                            ${cat.charAt(0).toUpperCase() + cat.slice(1)}
                            <button class="custom-category-remove" onclick="removeCustomCategory('${cat}', 'expense')">√ó</button>
                        </div>
                    `).join('');
                }
                
                // Display income categories
                if (incomeCategories.length > 0) {
                    html += '<div style="width: 100%; margin-top: 15px; margin-bottom: 10px;"><span style="color: #b0b0b0; font-size: 0.85em; font-weight: 600;">INCOME CATEGORIES:</span></div>';
                    html += incomeCategories.map(cat => `
                        <div class="custom-category-tag" style="background: #0a1f1a; border-color: #1a3d2e;">
                            ${cat.charAt(0).toUpperCase() + cat.slice(1)}
                            <button class="custom-category-remove" onclick="removeCustomCategory('${cat}', 'income')">√ó</button>
                        </div>
                    `).join('');
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error displaying categories:', error);
            }
        }

        // Remove custom category
        function removeCustomCategory(categoryName, type) {
            if (confirm(`Remove category "${categoryName}"?`)) {
                if (!userProfile.customCategories || Array.isArray(userProfile.customCategories)) {
                    userProfile.customCategories = {
                        expense: [],
                        income: []
                    };
                }
                
                userProfile.customCategories[type] = userProfile.customCategories[type].filter(c => c !== categoryName);
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                displayCustomCategories();
                updateCategoryOptions();
            }
        }

        // Update category dropdown in transaction form
        function updateCategoryDropdown() {
            updateCategoryOptions();
        }

        // Update category options based on transaction type
        function updateCategoryOptions() {
            const categorySelect = document.getElementById('category');
            const typeSelect = document.getElementById('type');
            const currentValue = categorySelect.value;
            const selectedType = typeSelect.value;
            
            // Initialize customCategories if it doesn't exist or is old format
            if (!userProfile.customCategories || Array.isArray(userProfile.customCategories)) {
                userProfile.customCategories = {
                    expense: [],
                    income: []
                };
            }
            
            let optionsHTML = '';
            
            if (selectedType === 'expense') {
                // Show only expense categories
                optionsHTML = `
                    <optgroup label="Expense Categories">
                        <option value="food">Food & Dining</option>
                        <option value="transport">Transportation</option>
                        <option value="education">Education</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="housing">Housing</option>
                        <option value="other">Other</option>
                    </optgroup>
                `;
                
                // Add custom expense categories if any exist
                if (userProfile.customCategories.expense && userProfile.customCategories.expense.length > 0) {
                    optionsHTML += '<optgroup label="Custom Expense Categories">';
                    userProfile.customCategories.expense.forEach(cat => {
                        optionsHTML += `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`;
                    });
                    optionsHTML += '</optgroup>';
                }
            } else {
                // Show only income categories
                optionsHTML = `
                    <optgroup label="Income Categories">
                        <option value="scholarship">Scholarship</option>
                        <option value="allowance">Allowance</option>
                        <option value="parttime">Part-time Job</option>
                    </optgroup>
                `;
                
                // Add custom income categories if any exist
                if (userProfile.customCategories.income && userProfile.customCategories.income.length > 0) {
                    optionsHTML += '<optgroup label="Custom Income Categories">';
                    userProfile.customCategories.income.forEach(cat => {
                        optionsHTML += `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`;
                    });
                    optionsHTML += '</optgroup>';
                }
            }
            
            categorySelect.innerHTML = optionsHTML;
            
            // Restore previous selection if it still exists
            if (currentValue) {
                const options = Array.from(categorySelect.options).map(opt => opt.value);
                if (options.includes(currentValue)) {
                    categorySelect.value = currentValue;
                }
            }
        }

        // Handle avatar upload
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size should be less than 5MB');
                    return;
                }

                // Check file type
                if (!file.type.startsWith('image/')) {
                    alert('Please upload an image file');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    userProfile.avatar = e.target.result;
                    updateAvatarDisplay();
                    document.getElementById('removePhotoBtn').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // Remove profile photo
        function removeProfilePhoto() {
            userProfile.avatar = null;
            updateAvatarDisplay();
            document.getElementById('avatarUpload').value = '';
            document.getElementById('removePhotoBtn').style.display = 'none';
        }

        // Update avatar display in modal and header
        function updateAvatarDisplay() {
            const avatarDisplay = document.getElementById('avatarDisplay');
            const avatarText = document.getElementById('avatarText');
            const avatarSmall = document.getElementById('avatarSmall');
            const avatarSmallText = document.getElementById('avatarSmallText');
            const removeBtn = document.getElementById('removePhotoBtn');

            if (userProfile.avatar) {
                // Show image
                avatarDisplay.style.backgroundImage = `url(${userProfile.avatar})`;
                avatarDisplay.style.backgroundSize = 'cover';
                avatarDisplay.style.backgroundPosition = 'center';
                avatarText.style.display = 'none';
                
                // Update small avatar
                avatarSmall.style.backgroundImage = `url(${userProfile.avatar})`;
                avatarSmall.style.backgroundSize = 'cover';
                avatarSmall.style.backgroundPosition = 'center';
                avatarSmallText.style.display = 'none';
                
                removeBtn.style.display = 'block';
            } else {
                // Show initials
                const initial = userProfile.name.charAt(0).toUpperCase();
                avatarDisplay.style.backgroundImage = 'none';
                avatarText.textContent = initial;
                avatarText.style.display = 'flex';
                
                // Update small avatar
                avatarSmall.style.backgroundImage = 'none';
                avatarSmallText.textContent = initial;
                avatarSmallText.style.display = 'flex';
                
                removeBtn.style.display = 'none';
            }
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function saveProfile() {
            userProfile.name = document.getElementById('profileName').value || 'Student';
            userProfile.email = document.getElementById('profileEmail').value;
            userProfile.phone = document.getElementById('profilePhone').value;
            userProfile.phoneCode = document.getElementById('phoneCode').value;
            userProfile.country = document.getElementById('profileCountry').value;
            userProfile.institutionType = document.getElementById('institutionType').value;
            userProfile.university = document.getElementById('profileUniversity').value;
            userProfile.studentId = document.getElementById('profileStudentId').value;
            // Currency is locked and cannot be changed
            // userProfile.currency remains unchanged

            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // Update display
            updateAvatarDisplay();
            
            // Update category dropdown (currency already locked, no need to update)
            updateCategoryDropdown();
            updateDashboard();
            displayTransactions();

            closeProfileModal();
            alert('Profile updated successfully!');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('profileModal');
            if (event.target == modal) {
                closeProfileModal();
            }
        }

        // Update currency symbol in form label and quick amounts
        function updateCurrencyLabel() {
            const symbol = getCurrencySymbol();
            document.getElementById('currencyLabel').textContent = symbol;
            
            // Update quick amount buttons
            const amounts = getQuickAmounts();
            const buttons = document.querySelectorAll('.quick-amount-btn:not([data-amount="custom"])');
            
            buttons.forEach((btn, index) => {
                if (index < amounts.length) {
                    btn.setAttribute('data-amount', amounts[index]);
                    btn.innerHTML = `<span class="amount-symbol">${symbol}</span>${amounts[index]}`;
                }
            });
            
            // Reset any active button
            quickAmountBtns.forEach(b => b.classList.remove('active'));
            document.querySelector('.quick-amount-btn[data-amount="custom"]').classList.add('active');
            lastClickedBtn = null;
        }

        // Initialize on load
        window.addEventListener('load', function() {
            // Check if currency selection is needed
            const isCurrencyLocked = localStorage.getItem('currencyLocked') === 'true';
            
            if (!isCurrencyLocked) {
                // Show currency selection first
                showCurrencySelection();
            } else {
                // Normal initialization
                updateDashboard();
                displayTransactions();
                updateCharts();
                
                // Load profile
                updateAvatarDisplay();
                updateCurrencyLabel();
                updateCategoryDropdown();
            }
        });
    </script>
</body>
</html>
