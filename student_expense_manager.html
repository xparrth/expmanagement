<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#006FCF">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Student Expense Manager</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Currency Selection Overlay (One-Time) -->
    <div id="currencySelectionOverlay" class="hidden">
        <div class="currency-selection-container">
            <h1>ğŸ’° Welcome!</h1>
            <p class="subtitle">Select your preferred currency for tracking expenses</p>
            
            <div class="currency-warning">
                <span>âš ï¸</span>
                <span>This is a ONE-TIME choice and cannot be changed later!</span>
            </div>
            
            <div class="currency-options-grid" id="currencyOptionsGrid">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <button class="confirm-currency-selection" id="confirmCurrencyBtn" disabled onclick="confirmCurrencySelection()">
                Confirm Selection
            </button>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <div class="profile-section">
                <div class="profile-avatar-small" id="avatarSmall">
                    <span id="avatarSmallText">S</span>
                </div>
                <button class="profile-btn" onclick="openProfileModal()">Edit Profile</button>
            </div>
            <h1>ğŸ’° Student Expense Manager</h1>
            <p>Track your finances, manage your budget, achieve your goals</p>
        </div>

        <div class="main-content">
            <!-- Dashboard Stats -->
            <div class="card dashboard-card full-width">
                <h2>Dashboard Overview</h2>
                
                <div class="dashboard-split">
                    <!-- Left Side: Stats -->
                    <div class="stats-section">
                        <div class="stats-grid">
                            <div class="stat-card income">
                                <h3>Income</h3>
                                <p id="totalIncome">$0.00</p>
                            </div>
                            <div class="stat-card expense">
                                <h3>Expenses</h3>
                                <p id="totalExpenses">$0.00</p>
                            </div>
                            <div class="stat-card balance">
                                <h3>Balance</h3>
                                <p id="balance">$0.00</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side: Budget Tracker -->
                    <div class="budget-section-wrapper">
                        <div class="budget-section">
                            <h3>Monthly Budget Tracker</h3>
                            <div class="form-group">
                                <input type="number" id="monthlyBudget" placeholder="Set your monthly budget" min="0">
                            </div>
                            <div class="budget-info">
                                <span class="budget-label">Spent</span>
                                <span class="budget-value" id="budgetPercentageText">$0.00</span>
                            </div>
                            <div class="budget-bar">
                                <div class="budget-progress" id="budgetProgress"></div>
                            </div>
                            <div class="budget-status-message" id="budgetStatus"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Transaction Form -->
            <div class="card add-transaction-card">
                <h2>Add Transaction</h2>
                <form id="transactionForm">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="type" required onchange="updateCategoryOptions()">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Amount (<span id="currencyLabel">$</span>)</label>
                        <div class="quick-amounts" id="quickAmountsContainer">
                            <button type="button" class="quick-amount-btn" data-amount="5"><span class="amount-symbol">$</span>5</button>
                            <button type="button" class="quick-amount-btn" data-amount="10"><span class="amount-symbol">$</span>10</button>
                            <button type="button" class="quick-amount-btn" data-amount="20"><span class="amount-symbol">$</span>20</button>
                            <button type="button" class="quick-amount-btn" data-amount="50"><span class="amount-symbol">$</span>50</button>
                            <button type="button" class="quick-amount-btn" data-amount="100"><span class="amount-symbol">$</span>100</button>
                            <button type="button" class="quick-amount-btn" data-amount="custom">Custom</button>
                            <button type="button" class="quick-amount-btn clear-amount-btn" onclick="clearAmount()">Clear</button>
                        </div>
                        <input type="number" id="amount" step="0.01" min="0.01" placeholder="0.00" required style="margin-top: 10px;">
                    </div>

                    <div class="form-group">
                        <label>Category</label>
                        <select id="category" required>
                            <optgroup label="Expense Categories">
                                <option value="food">Food & Dining</option>
                                <option value="transport">Transportation</option>
                                <option value="education">Education</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="housing">Housing</option>
                                <option value="other">Other</option>
                            </optgroup>
                            <optgroup label="Income Categories">
                                <option value="scholarship">Scholarship</option>
                                <option value="allowance">Allowance</option>
                                <option value="parttime">Part-time Job</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Description <span id="descriptionRequired" style="display: none; color: var(--danger);">*</span></label>
                        <input type="text" id="description" placeholder="e.g., Lunch at cafeteria">
                    </div>

                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="date" required>
                    </div>

                    <button type="submit" class="btn btn-primary">Add Transaction</button>
                </form>
            </div>

            <!-- Transactions List -->
            <div class="card transactions-card">
                <h2>Recent Transactions</h2>
                
                <div class="search-box">
                    <input type="text" id="searchTransaction" placeholder="ğŸ” Search transactions...">
                </div>

                <div class="filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="income">Income</button>
                    <button class="filter-btn" data-filter="expense">Expense</button>
                </div>

                <div class="transactions" id="transactionsList">
                    <div class="empty-state">
                        <p>No transactions yet. Add your first transaction!</p>
                    </div>
                </div>

                <div class="export-section">
                    <button class="btn btn-secondary" onclick="exportToCSV()">Get Details</button>
                    <button class="btn btn-warning" onclick="clearAllData()">Clear All</button>
                </div>
            </div>

            <!-- Analytics -->
            <div class="card analytics-card full-width">
                <h2>Analytics</h2>
                
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="showTab('categoryChart')">By Category</button>
                    <button class="tab-btn" onclick="showTab('monthlyChart')">Monthly Trend</button>
                </div>

                <div id="categoryChart" class="tab-content active">
                    <div class="chart-container">
                        <canvas id="expensePieChart"></canvas>
                    </div>
                </div>

                <div id="monthlyChart" class="tab-content">
                    <div class="chart-container">
                        <canvas id="monthlyBarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="close-btn" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="profile-avatar" id="avatarDisplay">
                    <span class="profile-avatar-text" id="avatarText">S</span>
                </div>
                <input type="file" id="avatarUpload" class="avatar-upload-btn" accept="image/*" onchange="handleAvatarUpload(event)">
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                    <button type="button" class="change-photo-btn" id="changePhotoBtn" onclick="document.getElementById('avatarUpload').click()">Upload Photo</button>
                    <button type="button" class="remove-photo-btn" id="removePhotoBtn" onclick="removeProfilePhoto()" style="display: none;">Remove Photo</button>
                </div>
                <form class="profile-form" id="profileForm">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="profileName" placeholder="Enter your name" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="profileEmail" placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <select id="profileCountry" onchange="updatePhoneCode()">
                            <option value="">Select Country</option>
                            <option value="US" data-code="+1">ğŸ‡ºğŸ‡¸ United States (+1)</option>
                            <option value="GB" data-code="+44">ğŸ‡¬ğŸ‡§ United Kingdom (+44)</option>
                            <option value="CA" data-code="+1">ğŸ‡¨ğŸ‡¦ Canada (+1)</option>
                            <option value="AU" data-code="+61">ğŸ‡¦ğŸ‡º Australia (+61)</option>
                            <option value="IN" data-code="+91">ğŸ‡®ğŸ‡³ India (+91)</option>
                            <option value="DE" data-code="+49">ğŸ‡©ğŸ‡ª Germany (+49)</option>
                            <option value="FR" data-code="+33">ğŸ‡«ğŸ‡· France (+33)</option>
                            <option value="JP" data-code="+81">ğŸ‡¯ğŸ‡µ Japan (+81)</option>
                            <option value="CN" data-code="+86">ğŸ‡¨ğŸ‡³ China (+86)</option>
                            <option value="SG" data-code="+65">ğŸ‡¸ğŸ‡¬ Singapore (+65)</option>
                            <option value="AE" data-code="+971">ğŸ‡¦ğŸ‡ª UAE (+971)</option>
                            <option value="SA" data-code="+966">ğŸ‡¸ğŸ‡¦ Saudi Arabia (+966)</option>
                            <option value="BR" data-code="+55">ğŸ‡§ğŸ‡· Brazil (+55)</option>
                            <option value="MX" data-code="+52">ğŸ‡²ğŸ‡½ Mexico (+52)</option>
                            <option value="ES" data-code="+34">ğŸ‡ªğŸ‡¸ Spain (+34)</option>
                            <option value="IT" data-code="+39">ğŸ‡®ğŸ‡¹ Italy (+39)</option>
                            <option value="RU" data-code="+7">ğŸ‡·ğŸ‡º Russia (+7)</option>
                            <option value="KR" data-code="+82">ğŸ‡°ğŸ‡· South Korea (+82)</option>
                            <option value="NL" data-code="+31">ğŸ‡³ğŸ‡± Netherlands (+31)</option>
                            <option value="CH" data-code="+41">ğŸ‡¨ğŸ‡­ Switzerland (+41)</option>
                            <option value="SE" data-code="+46">ğŸ‡¸ğŸ‡ª Sweden (+46)</option>
                            <option value="NO" data-code="+47">ğŸ‡³ğŸ‡´ Norway (+47)</option>
                            <option value="DK" data-code="+45">ğŸ‡©ğŸ‡° Denmark (+45)</option>
                            <option value="PL" data-code="+48">ğŸ‡µğŸ‡± Poland (+48)</option>
                            <option value="PK" data-code="+92">ğŸ‡µğŸ‡° Pakistan (+92)</option>
                            <option value="BD" data-code="+880">ğŸ‡§ğŸ‡© Bangladesh (+880)</option>
                            <option value="PH" data-code="+63">ğŸ‡µğŸ‡­ Philippines (+63)</option>
                            <option value="TH" data-code="+66">ğŸ‡¹ğŸ‡­ Thailand (+66)</option>
                            <option value="VN" data-code="+84">ğŸ‡»ğŸ‡³ Vietnam (+84)</option>
                            <option value="MY" data-code="+60">ğŸ‡²ğŸ‡¾ Malaysia (+60)</option>
                            <option value="ID" data-code="+62">ğŸ‡®ğŸ‡© Indonesia (+62)</option>
                            <option value="ZA" data-code="+27">ğŸ‡¿ğŸ‡¦ South Africa (+27)</option>
                            <option value="NG" data-code="+234">ğŸ‡³ğŸ‡¬ Nigeria (+234)</option>
                            <option value="EG" data-code="+20">ğŸ‡ªğŸ‡¬ Egypt (+20)</option>
                            <option value="TR" data-code="+90">ğŸ‡¹ğŸ‡· Turkey (+90)</option>
                            <option value="AR" data-code="+54">ğŸ‡¦ğŸ‡· Argentina (+54)</option>
                            <option value="CL" data-code="+56">ğŸ‡¨ğŸ‡± Chile (+56)</option>
                            <option value="CO" data-code="+57">ğŸ‡¨ğŸ‡´ Colombia (+57)</option>
                            <option value="NZ" data-code="+64">ğŸ‡³ğŸ‡¿ New Zealand (+64)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="phoneCode" readonly placeholder="+1" style="width: 80px; background: #1a1a1a; cursor: not-allowed;">
                            <input type="tel" id="profilePhone" placeholder="555-123-4567" style="flex: 1;">
                        </div>
                        <small style="color: #808080; font-size: 0.85em; display: block; margin-top: 5px;">
                            Select country to auto-fill phone code
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Institution Type</label>
                        <select id="institutionType" onchange="updateInstitutionList()">
                            <option value="">Select Type</option>
                            <option value="university">University/College</option>
                            <option value="school">School</option>
                        </select>
                    </div>
                    <div class="form-group" id="institutionSearchGroup" style="display: none;">
                        <label>Search Institution</label>
                        <input type="text" id="institutionSearch" placeholder="Type to search universities..." oninput="searchUniversities(this.value)">
                        <div id="universityResults" style="max-height: 200px; overflow-y: auto; border: 1px solid #2a2a2a; border-radius: 8px; margin-top: 5px; background: #0a0a0a; display: none;"></div>
                        <small style="color: #808080; font-size: 0.85em; display: block; margin-top: 5px;">
                            Search from 9,000+ universities worldwide
                        </small>
                    </div>
                    <div class="form-group" id="institutionSelectGroup" style="display: none;">
                        <label>Select School Type</label>
                        <select id="profileUniversitySelect" onchange="handleInstitutionSelect()">
                            <option value="">Select School Type</option>
                        </select>
                    </div>
                    <div class="form-group" id="institutionInputGroup">
                        <label>Institution Name</label>
                        <input type="text" id="profileUniversity" placeholder="Enter your institution name" readonly style="background: #1a1a1a;">
                        <small style="color: #808080; font-size: 0.85em; display: block; margin-top: 5px;">
                            Selected institution will appear here
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Student ID</label>
                        <input type="text" id="profileStudentId" placeholder="Your student ID">
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select id="profileCurrency" disabled style="background: #0a0a0a; cursor: not-allowed; opacity: 0.6;">
                            <option value="USD">USD ($) - US Dollar</option>
                            <option value="EUR">EUR (â‚¬) - Euro</option>
                            <option value="GBP">GBP (Â£) - British Pound</option>
                            <option value="JPY">JPY (Â¥) - Japanese Yen</option>
                            <option value="INR">INR (â‚¹) - Indian Rupee</option>
                            <option value="CAD">CAD ($) - Canadian Dollar</option>
                            <option value="AUD">AUD ($) - Australian Dollar</option>
                            <option value="CNY">CNY (Â¥) - Chinese Yuan</option>
                            <option value="CHF">CHF (Fr) - Swiss Franc</option>
                            <option value="SGD">SGD ($) - Singapore Dollar</option>
                            <option value="AED">AED (Ø¯.Ø¥) - UAE Dirham</option>
                            <option value="SAR">SAR (ï·¼) - Saudi Riyal</option>
                        </select>
                        <small style="color: #808080; font-size: 0.85em; display: block; margin-top: 5px;">
                            ğŸ”’ Currency is locked and cannot be changed
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>Custom Categories</label>
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="text" id="newCategoryInput" placeholder="Enter category name" style="flex: 1;">
                                <select id="newCategoryType" style="width: 120px; padding: 10px; background: #0a0a0a; color: #e0e0e0; border: 2px solid #2a2a2a; border-radius: 8px;">
                                    <option value="expense">Expense</option>
                                    <option value="income">Income</option>
                                </select>
                                <button type="button" class="btn-secondary" onclick="addCustomCategory()" style="padding: 10px 20px; white-space: nowrap;">Add Category</button>
                            </div>
                        </div>
                        <div id="customCategoriesList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                            <!-- Custom categories will appear here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeProfileModal()">Cancel</button>
                <button class="btn-save" onclick="saveProfile()">Save Changes</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Modern Alert/Popup System
        const modernAlert = {
            overlay: null,
            container: null,
            icon: null,
            title: null,
            message: null,
            buttons: null,
            
            init() {
                this.overlay = document.getElementById('modernAlertOverlay');
                this.container = this.overlay?.querySelector('.modern-alert-container');
                this.icon = document.getElementById('modernAlertIcon');
                this.title = document.getElementById('modernAlertTitle');
                this.message = document.getElementById('modernAlertMessage');
                this.buttons = document.getElementById('modernAlertButtons');
            },
            
            show(options) {
                if (!this.overlay) this.init();
                
                const {
                    type = 'info', // success, error, warning, info, question
                    title = 'Alert',
                    message = '',
                    confirmText = 'OK',
                    cancelText = 'Cancel',
                    showCancel = false,
                    onConfirm = () => {},
                    onCancel = () => {}
                } = options;
                
                // Set icon based on type
                const icons = {
                    success: 'âœ…',
                    error: 'âŒ',
                    warning: 'âš ï¸',
                    info: 'â„¹ï¸',
                    question: 'â“'
                };
                
                this.icon.textContent = icons[type] || icons.info;
                this.icon.className = `modern-alert-icon ${type}`;
                
                // Set title and message
                this.title.textContent = title;
                this.message.textContent = message;
                
                // Create buttons
                this.buttons.innerHTML = '';
                
                if (showCancel) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'modern-alert-btn modern-alert-btn-secondary';
                    cancelBtn.textContent = cancelText;
                    cancelBtn.onclick = () => {
                        this.hide();
                        onCancel();
                    };
                    this.buttons.appendChild(cancelBtn);
                }
                
                const confirmBtn = document.createElement('button');
                confirmBtn.className = `modern-alert-btn ${type === 'error' || type === 'warning' ? 'modern-alert-btn-danger' : 'modern-alert-btn-primary'}`;
                confirmBtn.textContent = confirmText;
                confirmBtn.onclick = () => {
                    this.hide();
                    onConfirm();
                };
                this.buttons.appendChild(confirmBtn);
                
                // Show overlay
                this.overlay.classList.add('active');
                
                // Focus on confirm button
                setTimeout(() => confirmBtn.focus(), 100);
                
                // Close on overlay click
                this.overlay.onclick = (e) => {
                    if (e.target === this.overlay) {
                        this.hide();
                        onCancel();
                    }
                };
                
                // Close on Escape key
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.hide();
                        onCancel();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            },
            
            hide() {
                if (this.overlay) {
                    this.overlay.classList.remove('active');
                }
            },
            
            // Convenience methods
            success(message, title = 'Success') {
                this.show({
                    type: 'success',
                    title,
                    message
                });
            },
            
            error(message, title = 'Error') {
                this.show({
                    type: 'error',
                    title,
                    message
                });
            },
            
            warning(message, title = 'Warning') {
                this.show({
                    type: 'warning',
                    title,
                    message
                });
            },
            
            info(message, title = 'Info') {
                this.show({
                    type: 'info',
                    title,
                    message
                });
            },
            
            confirm(message, onConfirm, onCancel, title = 'Confirm') {
                this.show({
                    type: 'question',
                    title,
                    message,
                    showCancel: true,
                    confirmText: 'Yes',
                    cancelText: 'No',
                    onConfirm,
                    onCancel: onCancel || (() => {})
                });
            }
        };
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            modernAlert.init();
        });
        // Currency configuration
        const availableCurrencies = [
            { code: 'USD', symbol: '$', name: 'US Dollar' },
            { code: 'EUR', symbol: 'â‚¬', name: 'Euro' },
            { code: 'GBP', symbol: 'Â£', name: 'British Pound' },
            { code: 'INR', symbol: 'â‚¹', name: 'Indian Rupee' },
            { code: 'JPY', symbol: 'Â¥', name: 'Japanese Yen' },
            { code: 'CAD', symbol: '$', name: 'Canadian Dollar' },
            { code: 'AUD', symbol: '$', name: 'Australian Dollar' },
            { code: 'CNY', symbol: 'Â¥', name: 'Chinese Yuan' },
            { code: 'CHF', symbol: 'Fr', name: 'Swiss Franc' },
            { code: 'SGD', symbol: '$', name: 'Singapore Dollar' },
            { code: 'AED', symbol: 'Ø¯.Ø¥', name: 'UAE Dirham' },
            { code: 'SAR', symbol: 'ï·¼', name: 'Saudi Riyal' }
        ];

        let selectedCurrencyForSetup = null;

        function showCurrencySelection() {
            console.log('showCurrencySelection called');
            const overlay = document.getElementById('currencySelectionOverlay');
            const grid = document.getElementById('currencyOptionsGrid');
            
            console.log('Overlay element:', overlay);
            console.log('Grid element:', grid);
            
            // Generate currency cards
            grid.innerHTML = availableCurrencies.map(curr => `
                <div class="currency-option-card" data-currency="${curr.code}">
                    <div class="currency-symbol-large">${curr.symbol}</div>
                    <div class="currency-code-large">${curr.code}</div>
                    <div class="currency-name-small">${curr.name}</div>
                </div>
            `).join('');
            
            console.log('Currency cards generated:', document.querySelectorAll('.currency-option-card').length);
            
            // Add click listeners
            document.querySelectorAll('.currency-option-card').forEach(card => {
                card.addEventListener('click', function() {
                    console.log('Card clicked:', this.getAttribute('data-currency'));
                    selectCurrencyOption(this.getAttribute('data-currency'));
                });
            });
            
            // Show overlay
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex';
            
            console.log('Overlay should be visible now');
        }

        function selectCurrencyOption(code) {
            selectedCurrencyForSetup = code;
            
            // Remove selected class from all
            document.querySelectorAll('.currency-option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            document.querySelector(`[data-currency="${code}"]`).classList.add('selected');
            
            // Enable confirm button
            document.getElementById('confirmCurrencyBtn').disabled = false;
        }

        window.confirmCurrencySelection = function() {
            console.log('Confirm button clicked!');
            console.log('Selected currency:', selectedCurrencyForSetup);
            
            if (!selectedCurrencyForSetup) {
                modernAlert.error('Please select a currency first!', 'No Currency Selected');
                return;
            }
            
            // Double confirmation
            const currencyInfo = availableCurrencies.find(c => c.code === selectedCurrencyForSetup);
            console.log('Currency info:', currencyInfo);
            
            modernAlert.confirm(
                `You are about to set ${currencyInfo.name} (${currencyInfo.symbol}) as your currency.\n\nâš ï¸ WARNING: This choice is PERMANENT and cannot be changed!\n\nAre you absolutely sure?`,
                () => {
                    console.log('User confirmed, locking currency...');
                    // Continue with currency setup
                    lockCurrencySetup(currencyInfo);
                },
                () => {
                    console.log('User cancelled confirmation');
                },
                'Confirm Currency'
            );
        };

        function lockCurrencySetup(currencyInfo) {
            
            // Ensure userProfile exists
            if (!userProfile) {
                userProfile = {
                    name: 'Student',
                    email: '',
                    phone: '',
                    phoneCode: '',
                    country: '',
                    university: '',
                    studentId: '',
                    avatar: null,
                    currency: 'USD',
                    customCategories: {
                        expense: [],
                        income: []
                    }
                };
            }
            
            // Lock the currency
            userProfile.currency = selectedCurrencyForSetup;
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            localStorage.setItem('currencyLocked', 'true');
            
            console.log('Currency locked successfully');
            
            // Hide overlay
            const overlay = document.getElementById('currencySelectionOverlay');
            overlay.classList.add('hidden');
            overlay.style.display = 'none';
            
            console.log('Initializing app...');
            
            // Initialize the app
            try {
                updateDashboard();
                displayTransactions();
                updateCharts();
                updateAvatarDisplay();
                updateCurrencyLabel();
                updateCategoryDropdown();
                
                modernAlert.success(`Currency set to ${currencyInfo.name}! This cannot be changed.`, 'Currency Set');
            } catch (error) {
                console.error('Error initializing app:', error);
                modernAlert.success('App initialized with ' + currencyInfo.name, 'App Ready');
            }
        };

        // Data storage
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let monthlyBudget = parseFloat(localStorage.getItem('monthlyBudget')) || 0;
        let currentFilter = 'all';
        let currentTransactionCurrency = 'USD'; // Track currency for current transaction
        let universitySearchTimeout = null;
        let cachedUniversities = null;

        // Major Universities by Country/Region
        const universities = {
            'US': [
                'Harvard University', 'Stanford University', 'MIT', 'Yale University', 'Princeton University',
                'Columbia University', 'University of Chicago', 'University of Pennsylvania', 'Cornell University',
                'Duke University', 'Northwestern University', 'Johns Hopkins University', 'Brown University',
                'University of California, Berkeley', 'UCLA', 'University of Michigan', 'New York University',
                'University of Southern California', 'Boston University', 'Carnegie Mellon University'
            ],
            'UK': [
                'University of Oxford', 'University of Cambridge', 'Imperial College London', 
                'University College London (UCL)', 'London School of Economics (LSE)', 
                'University of Edinburgh', 'King\'s College London', 'University of Manchester',
                'University of Bristol', 'University of Warwick', 'University of Glasgow'
            ],
            'CA': [
                'University of Toronto', 'McGill University', 'University of British Columbia',
                'McMaster University', 'University of Alberta', 'University of Waterloo',
                'Western University', 'Queen\'s University', 'University of Montreal'
            ],
            'AU': [
                'University of Melbourne', 'Australian National University', 'University of Sydney',
                'University of Queensland', 'Monash University', 'UNSW Sydney',
                'University of Western Australia', 'University of Adelaide'
            ],
            'IN': [
                'IIT Bombay', 'IIT Delhi', 'IIT Madras', 'IIT Kanpur', 'IIT Kharagpur', 'IIT Roorkee',
                'IISc Bangalore', 'BITS Pilani', 'Delhi University', 'Jawaharlal Nehru University',
                'University of Mumbai', 'University of Calcutta', 'Anna University', 'Banaras Hindu University',
                'Manipal Academy', 'Vellore Institute of Technology (VIT)', 'SRM Institute', 'Amity University'
            ],
            'CN': [
                'Tsinghua University', 'Peking University', 'Fudan University', 'Shanghai Jiao Tong University',
                'Zhejiang University', 'University of Science and Technology of China', 'Nanjing University'
            ],
            'JP': [
                'University of Tokyo', 'Kyoto University', 'Osaka University', 'Tohoku University',
                'Nagoya University', 'Keio University', 'Waseda University'
            ],
            'SG': [
                'National University of Singapore (NUS)', 'Nanyang Technological University (NTU)',
                'Singapore Management University (SMU)'
            ],
            'DE': [
                'Technical University of Munich', 'LMU Munich', 'Heidelberg University',
                'Humboldt University of Berlin', 'RWTH Aachen University', 'University of Freiburg'
            ],
            'FR': [
                'Sorbonne University', 'Ã‰cole Polytechnique', 'Sciences Po', 'ENS Paris',
                'University of Paris', 'Ã‰cole Normale SupÃ©rieure'
            ],
            'NL': [
                'University of Amsterdam', 'Delft University of Technology', 'Utrecht University',
                'Leiden University', 'Erasmus University Rotterdam'
            ],
            'CH': [
                'ETH Zurich', 'EPFL', 'University of Zurich', 'University of Geneva'
            ],
            'GLOBAL': [
                'Online University', 'Distance Learning Program', 'International Program'
            ]
        };

        // Schools by level
        const schools = {
            'high': [
                'High School', 'Secondary School', 'Grammar School', 'Preparatory School',
                'International High School', 'Private High School', 'Public High School'
            ],
            'middle': [
                'Middle School', 'Junior High School', 'Intermediate School'
            ],
            'primary': [
                'Primary School', 'Elementary School', 'Grade School'
            ],
            'boarding': [
                'Boarding School', 'Residential School', 'International Boarding School'
            ]
        };
        let userProfile = JSON.parse(localStorage.getItem('userProfile')) || {
            name: 'Student',
            email: '',
            phone: '',
            phoneCode: '',
            country: '',
            university: '',
            studentId: '',
            avatar: null,
            currency: 'USD',
            customCategories: {
                expense: [],
                income: []
            }
        };

        // Currency symbols mapping
        const currencySymbols = {
            'USD': '$',
            'EUR': 'â‚¬',
            'GBP': 'Â£',
            'JPY': 'Â¥',
            'INR': 'â‚¹',
            'CAD': '$',
            'AUD': '$',
            'CNY': 'Â¥',
            'CHF': 'Fr',
            'SGD': '$',
            'AED': 'Ø¯.Ø¥',
            'SAR': 'ï·¼'
        };

        // Quick amount values for different currencies
        const currencyQuickAmounts = {
            'USD': [5, 10, 20, 50, 100],
            'EUR': [5, 10, 20, 50, 100],
            'GBP': [5, 10, 20, 50, 100],
            'JPY': [500, 1000, 2000, 5000, 10000],
            'INR': [100, 200, 500, 1000, 2000],
            'CAD': [5, 10, 20, 50, 100],
            'AUD': [5, 10, 20, 50, 100],
            'CNY': [20, 50, 100, 200, 500],
            'CHF': [5, 10, 20, 50, 100],
            'SGD': [5, 10, 20, 50, 100],
            'AED': [20, 50, 100, 200, 500],
            'SAR': [20, 50, 100, 200, 500]
        };

        function getCurrencySymbol() {
            return currencySymbols[userProfile.currency] || '$';
        }

        function formatCurrency(amount) {
            const symbol = getCurrencySymbol();
            return `${symbol}${amount.toFixed(2)}`;
        }

        function getQuickAmounts() {
            return currencyQuickAmounts[userProfile.currency] || [5, 10, 20, 50, 100];
        }

        // Set today's date as default
        document.getElementById('date').valueAsDate = new Date();

        // Quick amount buttons functionality
        const amountInput = document.getElementById('amount');
        const quickAmountBtns = document.querySelectorAll('.quick-amount-btn');

        let lastClickedBtn = null;

        quickAmountBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const amount = this.dataset.amount;
                
                if(amount === 'custom') {
                    // Remove active class from all buttons
                    quickAmountBtns.forEach(b => b.classList.remove('active'));
                    // Add active class to custom button
                    this.classList.add('active');
                    amountInput.value = '';
                    amountInput.focus();
                    lastClickedBtn = null;
                } else if (!amount) {
                    // Skip for clear button (handled separately)
                    return;
                } else {
                    // Always add to existing amount (additive behavior)
                    const currentAmount = parseFloat(amountInput.value) || 0;
                    const addAmount = parseFloat(amount);
                    amountInput.value = (currentAmount + addAmount).toFixed(2);
                    
                    // Update active state
                    quickAmountBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    lastClickedBtn = this;
                }
            });
        });

        // Clear amount function
        function clearAmount() {
            amountInput.value = '';
            quickAmountBtns.forEach(b => b.classList.remove('active'));
            document.querySelector('.quick-amount-btn[data-amount="custom"]').classList.add('active');
            lastClickedBtn = null;
        }

        // When user types in custom amount, activate custom button
        amountInput.addEventListener('input', function() {
            const customBtn = document.querySelector('.quick-amount-btn[data-amount="custom"]');
            const isQuickAmount = Array.from(quickAmountBtns).some(btn => {
                return btn.dataset.amount !== 'custom' && btn.dataset.amount === this.value;
            });

            if(!isQuickAmount && this.value !== '') {
                quickAmountBtns.forEach(b => b.classList.remove('active'));
                customBtn.classList.add('active');
                lastClickedBtn = null; // Reset tracking when manually typing
            }
        });

        // Category change handler - make description required only for "other"
        const categorySelect = document.getElementById('category');
        const descriptionInput = document.getElementById('description');
        const descriptionRequired = document.getElementById('descriptionRequired');

        categorySelect.addEventListener('change', function() {
            if(this.value === 'other') {
                descriptionInput.setAttribute('required', 'required');
                descriptionRequired.style.display = 'inline';
                descriptionInput.placeholder = "Please specify what this is for";
            } else {
                descriptionInput.removeAttribute('required');
                descriptionRequired.style.display = 'none';
                descriptionInput.placeholder = "e.g., Lunch at cafeteria (optional)";
            }
        });

        // Set budget value
        document.getElementById('monthlyBudget').value = monthlyBudget || '';

        // Budget input listener
        document.getElementById('monthlyBudget').addEventListener('change', function() {
            monthlyBudget = parseFloat(this.value) || 0;
            localStorage.setItem('monthlyBudget', monthlyBudget);
            updateDashboard();
        });

        // Form submission
        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedCurrency = userProfile.currency;
            const currencySymbol = getCurrencySymbol();
            
            if(editingTransactionId) {
                // Update existing transaction
                const index = transactions.findIndex(t => t.id === editingTransactionId);
                if(index !== -1) {
                    transactions[index] = {
                        id: editingTransactionId,
                        type: document.getElementById('type').value,
                        amount: parseFloat(document.getElementById('amount').value),
                        category: document.getElementById('category').value,
                        description: document.getElementById('description').value,
                        date: document.getElementById('date').value,
                        currency: selectedCurrency,
                        currencySymbol: currencySymbol
                    };
                    
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    
                    // Show success message
                    modernAlert.success('Transaction updated successfully!', 'Updated');
                    
                    // Cancel edit mode
                    cancelEdit();
                }
            } else {
                // Add new transaction with currency
                const transaction = {
                    id: Date.now(),
                    type: document.getElementById('type').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    category: document.getElementById('category').value,
                    description: document.getElementById('description').value,
                    date: document.getElementById('date').value,
                    currency: selectedCurrency,
                    currencySymbol: currencySymbol
                };

                transactions.unshift(transaction);
                localStorage.setItem('transactions', JSON.stringify(transactions));

                // Reset form
                this.reset();
                document.getElementById('date').valueAsDate = new Date();

                // Reset quick amount buttons - deselect all
                quickAmountBtns.forEach(b => b.classList.remove('active'));
                document.querySelector('.quick-amount-btn[data-amount="custom"]').classList.add('active');
                lastClickedBtn = null;

                // Show success message
                modernAlert.success('Transaction added successfully!', 'Transaction Added');
            }

            // Update UI
            updateDashboard();
            displayTransactions();
            updateCharts();
        });

        // Display transactions
        function displayTransactions(filter = currentFilter, searchTerm = '') {
            const container = document.getElementById('transactionsList');
            
            let filtered = transactions;

            // Apply filter
            if (filter !== 'all') {
                filtered = filtered.filter(t => t.type === filter);
            }

            // Apply search
            if (searchTerm) {
                filtered = filtered.filter(t => 
                    t.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    t.category.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No transactions found.</p></div>';
                return;
            }

            container.innerHTML = filtered.map(t => {
                // Use transaction's original currency if available, otherwise use current
                const txnSymbol = t.currencySymbol || getCurrencySymbol();
                const txnCurrency = t.currency || userProfile.currency;
                
                return `
                <div class="transaction-item ${t.type}">
                    <div class="transaction-info">
                        <h4>${t.description}</h4>
                        <p>${new Date(t.date).toLocaleDateString()} 
                           <span class="category-tag category-${t.category}">${t.category}</span>
                           <span style="color: #606060; font-size: 0.85em;"> â€¢ ${txnCurrency}</span>
                        </p>
                    </div>
                    <div class="transaction-actions">
                        <span class="transaction-amount ${t.type}">
                            ${t.type === 'income' ? '+' : '-'}${txnSymbol}${t.amount.toFixed(2)}
                        </span>
                        <button class="btn btn-warning" onclick="editTransaction(${t.id})">âœï¸</button>
                        <button class="btn btn-danger" onclick="deleteTransaction(${t.id})">ğŸ—‘ï¸</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Delete transaction
        function deleteTransaction(id) {
            modernAlert.confirm(
                'Are you sure you want to delete this transaction?',
                () => {
                    transactions = transactions.filter(t => t.id !== id);
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    updateDashboard();
                    displayTransactions();
                    updateCharts();
                },
                null,
                'Delete Transaction'
            );
        }

        // Track if we're editing
        let editingTransactionId = null;

        // Edit transaction
        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            // Populate form with transaction data
            document.getElementById('type').value = transaction.type;
            document.getElementById('amount').value = transaction.amount;
            document.getElementById('category').value = transaction.category;
            document.getElementById('description').value = transaction.description;
            document.getElementById('date').value = transaction.date;

            // Update quick amount buttons to show custom
            quickAmountBtns.forEach(b => b.classList.remove('active'));
            document.querySelector('.quick-amount-btn[data-amount="custom"]').classList.add('active');

            // Set editing mode
            editingTransactionId = id;

            // Update submit button
            const submitBtn = document.querySelector('#transactionForm button[type="submit"]');
            submitBtn.textContent = 'Update Transaction';
            submitBtn.style.background = 'var(--warning)';

            // Scroll to form
            document.querySelector('#transactionForm').scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Show cancel button if not exists
            if(!document.getElementById('cancelEditBtn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.id = 'cancelEditBtn';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.textContent = 'Cancel Edit';
                cancelBtn.style.marginTop = '10px';
                cancelBtn.onclick = cancelEdit;
                submitBtn.parentNode.appendChild(cancelBtn);
            }
        }

        // Cancel edit mode
        function cancelEdit() {
            editingTransactionId = null;
            
            // Reset form
            document.getElementById('transactionForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            
            // Reset submit button
            const submitBtn = document.querySelector('#transactionForm button[type="submit"]');
            submitBtn.textContent = 'Add Transaction';
            submitBtn.style.background = 'var(--primary)';
            
            // Remove cancel button
            const cancelBtn = document.getElementById('cancelEditBtn');
            if(cancelBtn) {
                cancelBtn.remove();
            }
            
            // Reset quick amount buttons
            quickAmountBtns.forEach(b => b.classList.remove('active'));
            document.querySelector('.quick-amount-btn[data-amount="custom"]').classList.add('active');
        }

        // Update dashboard
        // Cache previous values to prevent unnecessary updates
        let lastDashboardValues = {
            income: null,
            expenses: null,
            balance: null
        };

        function updateDashboard() {
            // Group transactions by currency
            const currentCurrency = userProfile.currency;
            
            // Calculate totals for current currency only
            const income = transactions
                .filter(t => t.type === 'income' && (t.currency === currentCurrency || !t.currency))
                .reduce((sum, t) => sum + t.amount, 0);

            const expenses = transactions
                .filter(t => t.type === 'expense' && (t.currency === currentCurrency || !t.currency))
                .reduce((sum, t) => sum + t.amount, 0);

            const balance = income - expenses;

            // Only update if values have changed
            const incomeText = formatCurrency(income);
            const expensesText = formatCurrency(expenses);
            const balanceText = formatCurrency(balance);

            if (lastDashboardValues.income !== incomeText) {
                document.getElementById('totalIncome').textContent = incomeText;
                lastDashboardValues.income = incomeText;
            }

            if (lastDashboardValues.expenses !== expensesText) {
                document.getElementById('totalExpenses').textContent = expensesText;
                lastDashboardValues.expenses = expensesText;
            }

            if (lastDashboardValues.balance !== balanceText) {
                document.getElementById('balance').textContent = balanceText;
                lastDashboardValues.balance = balanceText;
            }

            // Update budget progress
            if (monthlyBudget > 0) {
                const percentage = (expenses / monthlyBudget) * 100;
                const progressBar = document.getElementById('budgetProgress');
                const percentageText = document.getElementById('budgetPercentageText');
                const statusElement = document.getElementById('budgetStatus');
                
                progressBar.style.width = Math.min(percentage, 100) + '%';
                percentageText.textContent = `${percentage.toFixed(1)}%`;
                
                // Remove all classes
                progressBar.classList.remove('warning', 'over');
                
                if (percentage > 100) {
                    progressBar.classList.add('over');
                    statusElement.innerHTML = 
                        `<span style="color: #ef4444;">Over budget by ${formatCurrency(expenses - monthlyBudget)}</span>`;
                } else if (percentage > 80) {
                    progressBar.classList.add('warning');
                    statusElement.innerHTML = 
                        `<span style="color: #f59e0b;">Remaining: ${formatCurrency(monthlyBudget - expenses)}</span>`;
                } else {
                    statusElement.innerHTML = 
                        `<span style="color: #10b981;">Remaining: ${formatCurrency(monthlyBudget - expenses)}</span>`;
                }
            } else {
                document.getElementById('budgetPercentageText').textContent = formatCurrency(0);
                document.getElementById('budgetStatus').innerHTML = '';
            }
        }

        // Filter transactions
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                displayTransactions(currentFilter);
            });
        });

        // Search functionality
        document.getElementById('searchTransaction').addEventListener('input', function() {
            displayTransactions(currentFilter, this.value);
        });

        // Export to CSV
        function exportToCSV() {
            if (transactions.length === 0) {
                modernAlert.warning('No transactions to export!', 'No Data');
                return;
            }

            const csv = [
                ['Date', 'Type', 'Category', 'Description', 'Amount'],
                ...transactions.map(t => [
                    t.date,
                    t.type,
                    t.category,
                    t.description,
                    t.amount
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Clear all data
        function clearAllData() {
            modernAlert.confirm(
                'Are you sure you want to delete ALL transactions? This cannot be undone!',
                () => {
                    transactions = [];
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    updateDashboard();
                    displayTransactions();
                    updateCharts();
                    modernAlert.success('All transactions have been deleted', 'Data Cleared');
                },
                null,
                'Delete All Transactions'
            );
        }

        // Charts
        let expenseChart = null;
        let monthlyChart = null;

        function updateCharts() {
            updateExpensePieChart();
            updateMonthlyBarChart();
        }

        function updateExpensePieChart() {
            const ctx = document.getElementById('expensePieChart').getContext('2d');
            
            const expensesByCategory = transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            const labels = Object.keys(expensesByCategory);
            const data = Object.values(expensesByCategory);

            if (expenseChart) {
                expenseChart.destroy();
            }

            if (labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = '#808080';
                ctx.font = '16px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No expense data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#f59e0b', // Food
                            '#3b82f6', // Transport
                            '#10b981', // Education
                            '#ec4899', // Entertainment
                            '#6366f1', // Housing
                            '#6b7280', // Other
                            '#8b5cf6', // Custom 1
                            '#14b8a6', // Custom 2
                            '#f97316', // Custom 3
                            '#06b6d4'  // Custom 4
                        ],
                        borderColor: '#1a1a1a',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e0e0e0',
                                padding: 15,
                                font: {
                                    size: 12,
                                    family: 'Inter, sans-serif'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Expenses by Category',
                            color: '#e0e0e0',
                            font: {
                                size: 16,
                                weight: 'bold',
                                family: 'Inter, sans-serif'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#2a2a2a',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${getCurrencySymbol()}${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateMonthlyBarChart() {
            const ctx = document.getElementById('monthlyBarChart').getContext('2d');
            
            // Get last 6 months
            const months = [];
            const incomeData = [];
            const expenseData = [];

            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                months.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));

                const monthIncome = transactions
                    .filter(t => t.type === 'income' && t.date.startsWith(monthKey))
                    .reduce((sum, t) => sum + t.amount, 0);

                const monthExpense = transactions
                    .filter(t => t.type === 'expense' && t.date.startsWith(monthKey))
                    .reduce((sum, t) => sum + t.amount, 0);

                incomeData.push(monthIncome);
                expenseData.push(monthExpense);
            }

            if (monthlyChart) {
                monthlyChart.destroy();
            }

            const hasData = incomeData.some(v => v > 0) || expenseData.some(v => v > 0);
            
            if (!hasData) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = '#808080';
                ctx.font = '16px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No transaction data for the last 6 months', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Income',
                            data: incomeData,
                            backgroundColor: '#10b981',
                            borderColor: '#059669',
                            borderWidth: 1,
                            borderRadius: 5
                        },
                        {
                            label: 'Expenses',
                            data: expenseData,
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 1,
                            borderRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e0e0e0',
                                padding: 15,
                                font: {
                                    size: 12,
                                    family: 'Inter, sans-serif'
                                },
                                usePointStyle: true,
                                pointStyle: 'rect'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Monthly Income vs Expenses',
                            color: '#e0e0e0',
                            font: {
                                size: 16,
                                weight: 'bold',
                                family: 'Inter, sans-serif'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#2a2a2a',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y || 0;
                                    return `${label}: ${getCurrencySymbol()}${value.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#e0e0e0',
                                font: {
                                    size: 11,
                                    family: 'Inter, sans-serif'
                                },
                                callback: function(value) {
                                    return getCurrencySymbol() + value.toFixed(0);
                                }
                            },
                            grid: {
                                color: '#2a2a2a',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0',
                                font: {
                                    size: 11,
                                    family: 'Inter, sans-serif'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // Tab switching
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Profile Modal Functions
        function openProfileModal() {
            document.getElementById('profileModal').style.display = 'block';
            document.getElementById('profileName').value = userProfile.name;
            document.getElementById('profileEmail').value = userProfile.email;
            document.getElementById('profilePhone').value = userProfile.phone;
            document.getElementById('profileCountry').value = userProfile.country || '';
            document.getElementById('phoneCode').value = userProfile.phoneCode || '';
            document.getElementById('profileUniversity').value = userProfile.university;
            document.getElementById('institutionType').value = userProfile.institutionType || '';
            document.getElementById('profileStudentId').value = userProfile.studentId;
            document.getElementById('profileCurrency').value = userProfile.currency;
            
            // Update avatar display ONLY in modal (not header)
            updateModalAvatarDisplay();
            displayCustomCategories();
            
            // Update institution list if type is set
            if (userProfile.institutionType) {
                updateInstitutionList();
            }
        }

        // Update institution list based on type and country
        function updateInstitutionList() {
            const type = document.getElementById('institutionType').value;
            const searchGroup = document.getElementById('institutionSearchGroup');
            const selectGroup = document.getElementById('institutionSelectGroup');
            const inputGroup = document.getElementById('institutionInputGroup');
            const input = document.getElementById('profileUniversity');
            
            // Reset displays
            searchGroup.style.display = 'none';
            selectGroup.style.display = 'none';
            document.getElementById('universityResults').style.display = 'none';
            
            if (!type) {
                input.value = '';
                input.removeAttribute('readonly');
                input.placeholder = 'Enter your institution name';
                return;
            }
            
            if (type === 'university') {
                // Show search box for universities
                searchGroup.style.display = 'block';
                input.setAttribute('readonly', 'readonly');
                input.style.background = '#1a1a1a';
                input.placeholder = 'Search for your university above';
                
            } else if (type === 'school') {
                // Show dropdown for schools
                selectGroup.style.display = 'block';
                const select = document.getElementById('profileUniversitySelect');
                
                let options = '<option value="">Select School Type</option>';
                options += '<optgroup label="High Schools">';
                schools['high'].forEach(school => {
                    options += `<option value="${school}">${school}</option>`;
                });
                options += '</optgroup>';
                
                options += '<optgroup label="Middle Schools">';
                schools['middle'].forEach(school => {
                    options += `<option value="${school}">${school}</option>`;
                });
                options += '</optgroup>';
                
                options += '<optgroup label="Primary Schools">';
                schools['primary'].forEach(school => {
                    options += `<option value="${school}">${school}</option>`;
                });
                options += '</optgroup>';
                
                options += '<optgroup label="Boarding Schools">';
                schools['boarding'].forEach(school => {
                    options += `<option value="${school}">${school}</option>`;
                });
                options += '</optgroup>';
                
                select.innerHTML = options;
                input.setAttribute('readonly', 'readonly');
                input.style.background = '#1a1a1a';
            }
        }

        // Search universities using API
        async function searchUniversities(query) {
            const resultsDiv = document.getElementById('universityResults');
            
            if (!query || query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            // Clear previous timeout
            if (universitySearchTimeout) {
                clearTimeout(universitySearchTimeout);
            }
            
            // Debounce search
            universitySearchTimeout = setTimeout(async () => {
                try {
                    resultsDiv.innerHTML = '<div style="padding: 10px; color: #808080;">Searching...</div>';
                    resultsDiv.style.display = 'block';
                    
                    // Fetch universities from API
                    const response = await fetch(`http://universities.hipolabs.com/search?name=${encodeURIComponent(query)}`);
                    
                    if (!response.ok) {
                        throw new Error('API request failed');
                    }
                    
                    const data = await response.json();
                    
                    if (data.length === 0) {
                        resultsDiv.innerHTML = '<div style="padding: 10px; color: #808080;">No universities found. Try a different search term.</div>';
                        return;
                    }
                    
                    // Limit to first 50 results
                    const universities = data.slice(0, 50);
                    
                    resultsDiv.innerHTML = universities.map(uni => `
                        <div onclick="selectUniversity('${uni.name.replace(/'/g, "\\'")}', '${uni.country}')" 
                             style="padding: 12px; cursor: pointer; border-bottom: 1px solid #1a1a1a; transition: background 0.2s;"
                             onmouseover="this.style.background='#1a1a1a'"
                             onmouseout="this.style.background='transparent'">
                            <div style="color: #e0e0e0; font-weight: 600;">${uni.name}</div>
                            <div style="color: #808080; font-size: 0.85em;">${uni.country}</div>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error('Error fetching universities:', error);
                    resultsDiv.innerHTML = `
                        <div style="padding: 10px; color: #ef4444;">
                            Unable to search online. Please check your internet connection or enter manually.
                        </div>
                    `;
                }
            }, 300); // Wait 300ms after user stops typing
        }

        // Select university from results
        function selectUniversity(name, country) {
            document.getElementById('profileUniversity').value = name;
            document.getElementById('institutionSearch').value = name;
            document.getElementById('universityResults').style.display = 'none';
        }

        // Handle institution selection (for schools)
        function handleInstitutionSelect() {
            const select = document.getElementById('profileUniversitySelect');
            const input = document.getElementById('profileUniversity');
            const value = select.value;
            
            if (value) {
                input.value = value;
            }
        }

        // Update phone code based on country selection
        function updatePhoneCode() {
            const countrySelect = document.getElementById('profileCountry');
            const selectedOption = countrySelect.options[countrySelect.selectedIndex];
            const phoneCode = selectedOption.getAttribute('data-code') || '';
            
            document.getElementById('phoneCode').value = phoneCode;
        }

        // Add custom category
        function addCustomCategory() {
            try {
                const input = document.getElementById('newCategoryInput');
                const typeSelect = document.getElementById('newCategoryType');
                
                if (!input || !typeSelect) {
                    console.error('Input elements not found');
                    return;
                }
                
                const categoryName = input.value.trim();
                const categoryType = typeSelect.value;
                
                if (!categoryName) {
                    modernAlert.warning('Please enter a category name', 'Missing Information');
                    return;
                }
                
                // Initialize customCategories if it doesn't exist or is old format
                if (!userProfile.customCategories || Array.isArray(userProfile.customCategories)) {
                    userProfile.customCategories = {
                        expense: [],
                        income: []
                    };
                }
                
                const lowerCaseName = categoryName.toLowerCase();
                
                // Check if category already exists in either type
                const allCategories = [...userProfile.customCategories.expense, ...userProfile.customCategories.income];
                if (allCategories.includes(lowerCaseName)) {
                    modernAlert.warning('This category already exists', 'Duplicate Category');
                    return;
                }
                
                // Add to profile based on type
                userProfile.customCategories[categoryType].push(lowerCaseName);
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                
                // Clear input and refresh display
                input.value = '';
                displayCustomCategories();
                updateCategoryOptions();
                
                console.log('Category added successfully:', categoryName, 'as', categoryType);
            } catch (error) {
                console.error('Error adding category:', error);
                modernAlert.error('Error adding category. Please try again.', 'Error');
            }
        }

        // Display custom categories
        function displayCustomCategories() {
            try {
                const container = document.getElementById('customCategoriesList');
                if (!container) {
                    console.error('Categories list container not found');
                    return;
                }
                
                // Initialize customCategories if it doesn't exist or is old format
                if (!userProfile.customCategories || Array.isArray(userProfile.customCategories)) {
                    userProfile.customCategories = {
                        expense: [],
                        income: []
                    };
                }
                
                const expenseCategories = userProfile.customCategories.expense || [];
                const incomeCategories = userProfile.customCategories.income || [];
                
                if (expenseCategories.length === 0 && incomeCategories.length === 0) {
                    container.innerHTML = '<span style="color: #808080; font-size: 0.9em;">No custom categories added yet</span>';
                    return;
                }
                
                let html = '';
                
                // Display expense categories
                if (expenseCategories.length > 0) {
                    html += '<div style="width: 100%; margin-bottom: 10px;"><span style="color: #b0b0b0; font-size: 0.85em; font-weight: 600;">EXPENSE CATEGORIES:</span></div>';
                    html += expenseCategories.map(cat => `
                        <div class="custom-category-tag" style="background: #2a1a0a; border-color: #3d2912;">
                            ${cat.charAt(0).toUpperCase() + cat.slice(1)}
                            <button class="custom-category-remove" onclick="removeCustomCategory('${cat}', 'expense')">Ã—</button>
                        </div>
                    `).join('');
                }
                
                // Display income categories
                if (incomeCategories.length > 0) {
                    html += '<div style="width: 100%; margin-top: 15px; margin-bottom: 10px;"><span style="color: #b0b0b0; font-size: 0.85em; font-weight: 600;">INCOME CATEGORIES:</span></div>';
                    html += incomeCategories.map(cat => `
                        <div class="custom-category-tag" style="background: #0a1f1a; border-color: #1a3d2e;">
                            ${cat.charAt(0).toUpperCase() + cat.slice(1)}
                            <button class="custom-category-remove" onclick="removeCustomCategory('${cat}', 'income')">Ã—</button>
                        </div>
                    `).join('');
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error displaying categories:', error);
            }
        }

        // Remove custom category
        function removeCustomCategory(categoryName, type) {
            modernAlert.confirm(
                `Remove category "${categoryName}"?`,
                () => {
                    if (!userProfile.customCategories || Array.isArray(userProfile.customCategories)) {
                        userProfile.customCategories = {
                            expense: [],
                            income: []
                        };
                    }
                    
                    userProfile.customCategories[type] = userProfile.customCategories[type].filter(c => c !== categoryName);
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                    displayCustomCategories();
                    updateCategoryOptions();
                    modernAlert.success(`Category "${categoryName}" has been removed`, 'Category Removed');
                },
                null,
                'Remove Category'
            );
        }

        // Update category dropdown in transaction form
        function updateCategoryDropdown() {
            updateCategoryOptions();
        }

        // Update category options based on transaction type
        function updateCategoryOptions() {
            const categorySelect = document.getElementById('category');
            const typeSelect = document.getElementById('type');
            const currentValue = categorySelect.value;
            const selectedType = typeSelect.value;
            
            // Initialize customCategories if it doesn't exist or is old format
            if (!userProfile.customCategories || Array.isArray(userProfile.customCategories)) {
                userProfile.customCategories = {
                    expense: [],
                    income: []
                };
            }
            
            let optionsHTML = '';
            
            if (selectedType === 'expense') {
                // Show only expense categories
                optionsHTML = `
                    <optgroup label="Expense Categories">
                        <option value="food">Food & Dining</option>
                        <option value="transport">Transportation</option>
                        <option value="education">Education</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="housing">Housing</option>
                        <option value="other">Other</option>
                    </optgroup>
                `;
                
                // Add custom expense categories if any exist
                if (userProfile.customCategories.expense && userProfile.customCategories.expense.length > 0) {
                    optionsHTML += '<optgroup label="Custom Expense Categories">';
                    userProfile.customCategories.expense.forEach(cat => {
                        optionsHTML += `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`;
                    });
                    optionsHTML += '</optgroup>';
                }
            } else {
                // Show only income categories
                optionsHTML = `
                    <optgroup label="Income Categories">
                        <option value="scholarship">Scholarship</option>
                        <option value="allowance">Allowance</option>
                        <option value="parttime">Part-time Job</option>
                    </optgroup>
                `;
                
                // Add custom income categories if any exist
                if (userProfile.customCategories.income && userProfile.customCategories.income.length > 0) {
                    optionsHTML += '<optgroup label="Custom Income Categories">';
                    userProfile.customCategories.income.forEach(cat => {
                        optionsHTML += `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`;
                    });
                    optionsHTML += '</optgroup>';
                }
            }
            
            categorySelect.innerHTML = optionsHTML;
            
            // Restore previous selection if it still exists
            if (currentValue) {
                const options = Array.from(categorySelect.options).map(opt => opt.value);
                if (options.includes(currentValue)) {
                    categorySelect.value = currentValue;
                }
            }
        }

        // Handle avatar upload
        // Temporary storage for preview
        let tempAvatarPreview = null;

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    modernAlert.warning('File size should be less than 5MB', 'File Too Large');
                    event.target.value = '';
                    return;
                }

                // Check file type
                if (!file.type.startsWith('image/')) {
                    modernAlert.warning('Please upload an image file', 'Invalid File Type');
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    // Store in temporary preview (don't save to userProfile yet)
                    tempAvatarPreview = e.target.result;
                    
                    // Show preview in modal only
                    const avatarDisplay = document.getElementById('avatarDisplay');
                    const avatarText = document.getElementById('avatarText');
                    const changeBtn = document.getElementById('changePhotoBtn');
                    
                    avatarDisplay.style.backgroundImage = `url(${tempAvatarPreview})`;
                    avatarDisplay.style.backgroundSize = 'cover';
                    avatarDisplay.style.backgroundPosition = 'center';
                    avatarText.style.display = 'none';
                    
                    document.getElementById('removePhotoBtn').style.display = 'block';
                    changeBtn.textContent = 'Change Photo';
                    
                    // Show preview indicator
                    const previewIndicator = document.createElement('div');
                    previewIndicator.id = 'photoPreviewIndicator';
                    previewIndicator.style.cssText = 'background: rgba(37, 99, 235, 0.9); color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.85em; margin-top: 10px; display: inline-block;';
                    previewIndicator.textContent = 'ğŸ“· Preview - Click "Save Changes" to apply';
                    
                    // Remove existing indicator if any
                    const existing = document.getElementById('photoPreviewIndicator');
                    if (existing) existing.remove();
                    
                    // Add new indicator
                    avatarDisplay.parentElement.appendChild(previewIndicator);
                };
                reader.readAsDataURL(file);
            }
        }

        // Flag to mark photo for removal
        let markPhotoForRemoval = false;

        // Remove profile photo (preview or mark for removal)
        function removeProfilePhoto() {
            // Clear temporary preview
            tempAvatarPreview = null;
            
            // Mark for removal if there's a saved avatar
            if (userProfile.avatar) {
                markPhotoForRemoval = true;
            }
            
            // Reset avatar display in modal to show initial letter
            const avatarDisplay = document.getElementById('avatarDisplay');
            const avatarText = document.getElementById('avatarText');
            const changeBtn = document.getElementById('changePhotoBtn');
            
            avatarDisplay.style.backgroundImage = 'none';
            avatarText.style.display = 'flex';
            avatarText.textContent = (userProfile.name || 'S').charAt(0).toUpperCase();
            
            document.getElementById('avatarUpload').value = '';
            document.getElementById('removePhotoBtn').style.display = 'none';
            changeBtn.textContent = 'Upload Photo';
            
            // Remove preview indicator
            const previewIndicator = document.getElementById('photoPreviewIndicator');
            if (previewIndicator) previewIndicator.remove();
            
            // Show removal indicator
            const removalIndicator = document.createElement('div');
            removalIndicator.id = 'photoRemovalIndicator';
            removalIndicator.style.cssText = 'background: rgba(239, 68, 68, 0.9); color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.85em; margin-top: 10px; display: inline-block;';
            removalIndicator.textContent = 'ğŸ—‘ï¸ Photo will be removed - Click "Save Changes" to apply';
            
            avatarDisplay.parentElement.appendChild(removalIndicator);
        }

        // Update avatar display ONLY in modal (for previewing)
        function updateModalAvatarDisplay() {
            const avatarDisplay = document.getElementById('avatarDisplay');
            const avatarText = document.getElementById('avatarText');
            const removeBtn = document.getElementById('removePhotoBtn');
            const changeBtn = document.getElementById('changePhotoBtn');

            if (userProfile.avatar) {
                // Show saved image in modal
                avatarDisplay.style.backgroundImage = `url(${userProfile.avatar})`;
                avatarDisplay.style.backgroundSize = 'cover';
                avatarDisplay.style.backgroundPosition = 'center';
                avatarText.style.display = 'none';
                removeBtn.style.display = 'block';
                changeBtn.textContent = 'Change Photo';
            } else {
                // Show initials in modal
                const initial = (userProfile.name || 'S').charAt(0).toUpperCase();
                avatarDisplay.style.backgroundImage = 'none';
                avatarText.textContent = initial;
                avatarText.style.display = 'flex';
                removeBtn.style.display = 'none';
                changeBtn.textContent = 'Upload Photo';
            }
        }

        // Update avatar display in modal AND header (after saving)
        function updateAvatarDisplay() {
            const avatarDisplay = document.getElementById('avatarDisplay');
            const avatarText = document.getElementById('avatarText');
            const avatarSmall = document.getElementById('avatarSmall');
            const avatarSmallText = document.getElementById('avatarSmallText');
            const removeBtn = document.getElementById('removePhotoBtn');

            if (userProfile.avatar) {
                // Show image in both modal and header
                avatarDisplay.style.backgroundImage = `url(${userProfile.avatar})`;
                avatarDisplay.style.backgroundSize = 'cover';
                avatarDisplay.style.backgroundPosition = 'center';
                avatarText.style.display = 'none';
                
                // Update small avatar (header)
                avatarSmall.style.backgroundImage = `url(${userProfile.avatar})`;
                avatarSmall.style.backgroundSize = 'cover';
                avatarSmall.style.backgroundPosition = 'center';
                avatarSmallText.style.display = 'none';
                
                removeBtn.style.display = 'block';
            } else {
                // Show initials in both modal and header
                const initial = (userProfile.name || 'S').charAt(0).toUpperCase();
                avatarDisplay.style.backgroundImage = 'none';
                avatarText.textContent = initial;
                avatarText.style.display = 'flex';
                
                // Update small avatar (header)
                avatarSmall.style.backgroundImage = 'none';
                avatarSmallText.textContent = initial;
                avatarSmallText.style.display = 'flex';
                
                removeBtn.style.display = 'none';
            }
        }

        function closeProfileModal() {
            // Reset preview if user cancels without saving
            if (tempAvatarPreview !== null || markPhotoForRemoval) {
                tempAvatarPreview = null;
                markPhotoForRemoval = false;
                
                // Reset modal avatar display
                const avatarDisplay = document.getElementById('avatarDisplay');
                const avatarText = document.getElementById('avatarText');
                
                if (userProfile.avatar) {
                    avatarDisplay.style.backgroundImage = `url(${userProfile.avatar})`;
                    avatarDisplay.style.backgroundSize = 'cover';
                    avatarDisplay.style.backgroundPosition = 'center';
                    avatarText.style.display = 'none';
                } else {
                    avatarDisplay.style.backgroundImage = 'none';
                    avatarText.style.display = 'flex';
                    avatarText.textContent = (userProfile.name || 'S').charAt(0).toUpperCase();
                }
                
                // Clear file input
                document.getElementById('avatarUpload').value = '';
                
                // Remove preview indicator
                const previewIndicator = document.getElementById('photoPreviewIndicator');
                if (previewIndicator) previewIndicator.remove();
                
                // Remove removal indicator
                const removalIndicator = document.getElementById('photoRemovalIndicator');
                if (removalIndicator) removalIndicator.remove();
                
                // Show/hide remove button based on saved avatar
                const removeBtn = document.getElementById('removePhotoBtn');
                if (removeBtn) {
                    removeBtn.style.display = userProfile.avatar ? 'block' : 'none';
                }
            }
            
            document.getElementById('profileModal').style.display = 'none';
        }

        function saveProfile() {
            userProfile.name = document.getElementById('profileName').value || 'Student';
            userProfile.email = document.getElementById('profileEmail').value;
            userProfile.phone = document.getElementById('profilePhone').value;
            userProfile.phoneCode = document.getElementById('phoneCode').value;
            userProfile.country = document.getElementById('profileCountry').value;
            userProfile.institutionType = document.getElementById('institutionType').value;
            userProfile.university = document.getElementById('profileUniversity').value;
            userProfile.studentId = document.getElementById('profileStudentId').value;
            // Currency is locked and cannot be changed
            // userProfile.currency remains unchanged

            // Apply the avatar preview if exists
            if (tempAvatarPreview !== null) {
                userProfile.avatar = tempAvatarPreview;
                tempAvatarPreview = null; // Clear temp after saving
            }
            
            // Remove avatar if marked for removal
            if (markPhotoForRemoval) {
                userProfile.avatar = null;
                markPhotoForRemoval = false; // Reset flag
            }

            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // Remove preview indicator
            const previewIndicator = document.getElementById('photoPreviewIndicator');
            if (previewIndicator) previewIndicator.remove();
            
            // Remove removal indicator
            const removalIndicator = document.getElementById('photoRemovalIndicator');
            if (removalIndicator) removalIndicator.remove();
            
            // Update display
            updateAvatarDisplay();
            
            // Update category dropdown (currency already locked, no need to update)
            updateCategoryDropdown();
            updateDashboard();
            displayTransactions();

            closeProfileModal();
            modernAlert.success('Profile updated successfully!', 'Profile Saved');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('profileModal');
            if (event.target == modal) {
                closeProfileModal();
            }
        }

        // Update currency symbol in form label and quick amounts
        function updateCurrencyLabel() {
            const symbol = getCurrencySymbol();
            document.getElementById('currencyLabel').textContent = symbol;
            
            // Update quick amount buttons
            const amounts = getQuickAmounts();
            const buttons = document.querySelectorAll('.quick-amount-btn:not([data-amount="custom"])');
            
            buttons.forEach((btn, index) => {
                if (index < amounts.length) {
                    btn.setAttribute('data-amount', amounts[index]);
                    btn.innerHTML = `<span class="amount-symbol">${symbol}</span>${amounts[index]}`;
                }
            });
            
            // Reset any active button
            quickAmountBtns.forEach(b => b.classList.remove('active'));
            document.querySelector('.quick-amount-btn[data-amount="custom"]').classList.add('active');
            lastClickedBtn = null;
        }

        // Initialize on load
        window.addEventListener('load', function() {
            // Check if currency selection is needed
            const isCurrencyLocked = localStorage.getItem('currencyLocked') === 'true';
            
            if (!isCurrencyLocked) {
                // Show currency selection first
                showCurrencySelection();
            } else {
                // Normal initialization
                updateDashboard();
                displayTransactions();
                updateCharts();
                
                // Load profile
                updateAvatarDisplay();
                updateCurrencyLabel();
                updateCategoryDropdown();
            }
        });
    </script>
    <!-- Modern Popup/Alert System -->
    <div id="modernAlertOverlay" class="modern-alert-overlay">
        <div class="modern-alert-container">
            <div class="modern-alert-icon" id="modernAlertIcon">
                <!-- Icon will be inserted here -->
            </div>
            <div class="modern-alert-title" id="modernAlertTitle">Alert</div>
            <div class="modern-alert-message" id="modernAlertMessage">Message here</div>
            <div class="modern-alert-buttons" id="modernAlertButtons">
                <button class="modern-alert-btn modern-alert-btn-primary" id="modernAlertOkBtn">OK</button>
            </div>
        </div>
    </div>
</html>
